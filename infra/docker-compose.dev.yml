services:
  bff:
    build:
      context: ..
      dockerfile: apps/bff/Dockerfile.dev
    working_dir: /app/apps/bff
    volumes:
      - ../:/app
    command: uvicorn app.main:APP --host 0.0.0.0 --port 8000 --reload
    environment:
    - ENV=dev
    - SESSION_SECRET=dev-secret
    - AUTH_MODE=mock
    - EP_MODE=mock
    # Evita WARN enquanto estamos no mock:
    - CS_ISSUER=${CS_ISSUER:-https://example.invalid/centralautenticacao}
    - CS_AUTH_URL=${CS_AUTH_URL:-https://example.invalid/centralautenticacao/oauth2/authorize}
    - CS_TOKEN_URL=${CS_TOKEN_URL:-https://example.invalid/centralautenticacao/api/v1/token/jwt}
    - CS_JWKS_URL=${CS_JWKS_URL:-https://example.invalid/centralautenticacao/.well-known/jwks.json}
    - CS_CLIENT_ID=${CS_CLIENT_ID:-dev}
    - CS_CLIENT_SECRET=${CS_CLIENT_SECRET:-dev}
    - CS_REDIRECT_URL=${CS_REDIRECT_URL:-http://localhost:8000/auth/callback}
    - CS_SCOPES=openid email profile
    - EP_SCOPES=spiserv.protocolos.consultar
    ports: ["8000:8000"]


  host:
    image: node:20-alpine
    working_dir: /app/apps/host
    command: sh -lc "npm i && npm run dev"
    environment:
      - VITE_CATALOG_URL=http://localhost:8000/catalog/dev
    volumes:
      - ../:/app
    ports: ["5173:5173"]
