services:
  bff:
    build:
      context: ../apps/bff
      dockerfile: Dockerfile.dev
    container_name: portal-agepar-bff
    environment:
      ENV: dev
      AUTH_MODE: mock
      EP_MODE: mock
      SESSION_SECRET: dev-secret
      CORS_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
      CATALOG_FILE: /catalog/catalog.dev.json
    volumes:
      - ../apps/bff:/app
      - ../catalog:/catalog:ro
    ports:
      - "8000:8000"
    command: ./run_dev.sh
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  host:
    image: node:20-alpine
    container_name: portal-agepar-host
    working_dir: /workspace
    environment:
      VITE_CATALOG_URL: /catalog/dev
      VITE_API_BASE: /api
      CHOKIDAR_USEPOLLING: "1"
      FORCE_COLOR: "1"
    volumes:
      - ../apps/host:/workspace
      - portal_agepar_node_modules:/workspace/node_modules
    ports:
      - "5173:5173"
    command: sh -lc 'test -f package-lock.json && npm ci || npm install; npm run dev -- --host 0.0.0.0 --port 5173'
    depends_on:
      - bff
      - docs
    restart: unless-stopped

  docs:
    build:
      context: ../
      dockerfile: docs/Dockerfile.dev
    container_name: portal-agepar-docs
    working_dir: /workspace
    volumes:
      - ../docs:/workspace/docs:ro
      - ../mkdocs.yml:/workspace/mkdocs.yml:ro
    expose:
      - "8000"
    restart: unless-stopped

volumes:
  portal_agepar_node_modules:
