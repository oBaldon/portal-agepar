services:
  bff:
    build:
      context: ../apps/bff
      dockerfile: Dockerfile.dev
    container_name: portal-agepar-bff
    environment:
      ENV: dev
      AUTH_MODE: mock
      AUTH_DEFAULT_ROLES: "user,compras,ferias"
      EP_MODE: mock
      SESSION_SECRET: dev-secret
      CORS_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
      CATALOG_FILE: /catalog/catalog.dev.json
      AUTH_RATE_LIMIT_SCOPE: identifier   # ou "off" em dev
      AUTH_RATE_LIMIT_WINDOW_MINUTES: "10"
      AUTH_RATE_LIMIT_MAX_ATTEMPTS: "7"
      LOG_LEVEL: INFO
      AUTH_ENABLE_SELF_REGISTER: "false"
      ACCOUNTS_CREATE_LEGACY_ENABLED: "false"  # LEGADO: criação de contas desativada (true => habilita compat)
    volumes:
      - ../apps/bff:/app
      - ../catalog:/catalog:ro
    ports:
      - "8000:8000"
    command: ./run_dev.sh
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  host:
    image: node:20-alpine
    container_name: portal-agepar-host
    working_dir: /workspace
    environment:
      VITE_CATALOG_URL: /catalog/dev
      VITE_API_BASE: /api
      VITE_ENABLE_SELF_REGISTER: "false"   # desativa o auto-registro no Host
      CHOKIDAR_USEPOLLING: "1"
      FORCE_COLOR: "1"
    volumes:
      - ../apps/host:/workspace
      - portal_agepar_node_modules:/workspace/node_modules
    ports:
      - "5173:5173"
    command: sh -lc 'test -f package-lock.json && npm ci || npm install; npm run dev -- --host 0.0.0.0 --port 5173'
    depends_on:
      - bff
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  portal_agepar_node_modules:
