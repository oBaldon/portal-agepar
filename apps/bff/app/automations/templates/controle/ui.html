<!-- app/automations/templates/controle/ui.html -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Painel de Controle — Auditoria</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --pri:#2563eb; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Noto Color Emoji',sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .card { background:var(--card); border:1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding: 16px; }

  label { display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
  input:not([type="checkbox"]):not([type="radio"]), select { width: 100%; padding: 10px 12px; border:1px solid #cbd5e1; border-radius: 10px; font: inherit; background:#fff; }
  .row { display:flex; gap: 12px; }
  .col { flex:1; min-width: 0; }

  .actions { display:flex; gap: 12px; align-items:center; justify-content: space-between; }
  .btn { background: var(--pri); color:#fff; border:1px solid transparent; border-radius: 10px; padding: 10px 16px; cursor:pointer; transition:.16s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(2,6,23,.08); }
  .btn:focus-visible { outline: 2px solid #93c5fd; outline-offset: 2px; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.secondary:hover { background:#f8fafc; }
  .btn.small { padding: 8px 12px; font-size: 12px; }
  .note { font-size:12px; color:var(--muted); }
  .status { font-size:13px; color: var(--muted); }

  /* Full-bleed para a seção de eventos */
  .fullbleed {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    border-radius: 0;
    border-left: 0;
    border-right: 0;
  }

  /* Tabela */
  .table-wrap { overflow:auto; border:1px solid #e2e8f0; border-radius:12px; }
  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { padding:10px 12px; border-bottom:1px solid #eef2f7; vertical-align: top; text-align:left; }
  th { font-size:12px; color:#64748b; background:#f8fafc; position:sticky; top:0; z-index:1; }
  tr:hover td { background:#fbfdff; }
  .nowrap { white-space: nowrap; }

  .btn-row { display:flex; gap:8px; flex-wrap: wrap; }
  .btn.ghost { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.ghost:hover { background:#f8fafc; }

  @media (max-width: 640px) {
    .actions { flex-direction: column; align-items: stretch; gap: 8px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Painel de Controle — Auditoria</h1>
    <span class="note">Somente leitura • Diretores/Admin</span>
  </div>

  <!-- Filtros -->
  <div class="card" aria-labelledby="filtros-title">
    <h2 id="filtros-title" style="font-size:16px; margin:0 0 8px">Filtros</h2>
    <div class="row">
      <div class="col">
        <label for="kind">Tipo</label>
        <select id="kind">
          <option value="dfd" selected>DFD</option>
          <option value="">(Todos)</option>
        </select>
      </div>
      <div class="col">
        <label for="username">Servidor (nome ou CPF)</label>
        <input id="username" placeholder="Ex.: Maria, 12345678901" />
      </div>
      <div class="col">
        <label for="action">Ação</label>
        <!-- será populado dinamicamente -->
        <select id="action">
          <option value="">(Todas)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="since">Desde</label>
        <input id="since" type="datetime-local" />
      </div>
      <div class="col">
        <label for="until">Até</label>
        <input id="until" type="datetime-local" />
      </div>
      <div class="col" style="max-width:180px">
        <label for="limit">Limite</label>
        <input id="limit" type="number" value="100" min="1" max="1000" />
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <span class="status" id="status" role="status" aria-live="polite"></span>
      <div>
        <button id="btnCsv" class="btn secondary small" type="button">Exportar CSV</button>
        <button id="btnApply" class="btn" type="button">Aplicar filtros</button>
      </div>
    </div>
  </div>
</div>

<!-- Resultados (full-bleed) -->
<div class="card fullbleed" style="margin-top:16px" aria-labelledby="result-title">
  <div class="wrap" style="max-width: 1440px;">
    <h2 id="result-title" style="font-size:16px; margin:0 0 8px">Eventos</h2>
    <div class="table-wrap">
      <table id="tbl" aria-describedby="status">
        <thead>
          <tr>
            <th class="nowrap">Quando</th>
            <th>Servidor</th>
            <th>Ação</th>
            <th>Alvo</th>
            <th>Nome</th>
            <th>Assunto</th>
            <th class="nowrap">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="note" style="margin-top:8px">Dica: downloads aparecem quando a ação é “completed”.</div>
  </div>
</div>

<script>
  const DEBUG = true;
  const qs = (sel) => document.querySelector(sel);

  function fmtTs(s){
    if(!s) return "";
    const d = new Date(s);
    return isNaN(d) ? String(s) : d.toLocaleString();
  }
  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }
  function toISO(dtLocalStr){
    if(!dtLocalStr) return "";
    const d = new Date(dtLocalStr);
    return isNaN(d) ? "" : d.toISOString();
  }
  function toObj(x){
    if(!x) return {};
    if(typeof x === "string"){ try { return JSON.parse(x); } catch { return {}; } }
    if(typeof x === "object") return x;
    return {};
  }
  function buildAssuntoFromPayload(p){
    const assunto = (p.assunto || "").toString().trim();
    const ano = (p.pcaAno || p.pca_ano || "").toString().trim();
    if(assunto && ano) return `DFD - PCA ${ano} - ${assunto}`;
    return assunto || (p.objeto || "");
  }
  function getSid(row){
    const extra = row.extra || {};
    return extra.sid || extra.submissionId || extra.id || row.target_id || null;
  }

  async function downloadFmt(sid, fmt){
    try{
      const url = fmt ? `/api/automations/dfd/submissions/${encodeURIComponent(sid)}/download/${fmt}`
                      : `/api/automations/dfd/submissions/${encodeURIComponent(sid)}/download`;
      const r = await fetch(url, { method: 'POST', credentials: 'include' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const blob = await r.blob();
      const a = document.createElement('a');
      const name = (fmt==='pdf' ? `dfd_${sid}.pdf` : `dfd_${sid}.docx`);
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
      if (DEBUG) console.info("[controle] download ok", { sid, fmt, size: blob.size });
    }catch(e){
      console.error("[controle] download error", { sid, fmt, error: e });
      alert('Não foi possível baixar o arquivo.');
    }
  }

  async function loadActions(){
    const sel = qs("#action");
    const keep = sel.value;
    try{
      const r = await fetch(`/api/automations/controle/actions`, { credentials: "include" });
      if (DEBUG) console.debug("[controle] GET /actions -> status", r.status);
      if(!r.ok) throw new Error();
      const data = await r.json();
      const items = Array.isArray(data.items) ? data.items : [];
      if (DEBUG) console.debug("[controle] actions payload", data);

      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = ""; optAll.textContent = "(Todas)";
      sel.appendChild(optAll);
      for(const a of items){
        const o = document.createElement("option");
        o.value = a; o.textContent = a;
        sel.appendChild(o);
      }
      if(items.includes("completed")) sel.value = "completed";
      else if(keep) sel.value = keep;
      if (DEBUG) console.debug("[controle] actions options set; selected:", sel.value);
    }catch(_){
      const defaults = ["submitted","running","completed","failed","download"];
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = ""; optAll.textContent = "(Todas)";
      sel.appendChild(optAll);
      defaults.forEach(a=>{
        const o = document.createElement("option");
        o.value = a; o.textContent = a;
        sel.appendChild(o);
      });
      sel.value = "completed";
      if (DEBUG) console.warn("[controle] actions fallback applied; selected:", sel.value);
    }
  }

  async function load(){
    const params = new URLSearchParams();
    const limit = Number(qs("#limit").value || 100);
    const kind = qs("#kind").value.trim();
    const username = qs("#username").value.trim();
    const action = qs("#action").value.trim();
    const since = qs("#since").value;
    const until = qs("#until").value;

    if (limit) params.set("limit", String(limit));
    if (kind) params.set("kind", kind);
    if (username) params.set("username", username);
    if (action) params.set("action", action);
    if (since) params.set("since", toISO(since));
    if (until) params.set("until", toISO(until));

    qs("#status").textContent = "Carregando...";
    if (DEBUG) console.groupCollapsed("[controle] load audits", {
      url: "/api/automations/controle/audits",
      params: Object.fromEntries(params.entries())
    });

    try{
      const url = `/api/automations/controle/audits?` + params.toString();
      const resp = await fetch(url, { credentials: "include" });
      if (DEBUG) console.debug("[controle] response status", resp.status, url);

      if(!resp.ok){
        const t = await resp.text();
        qs("#status").textContent = `Erro ${resp.status}: ${t}`;
        console.error("[controle] load error", { status: resp.status, body: t });
        console.groupEnd?.();
        return;
      }
      const data = await resp.json();
      if (DEBUG) {
        console.debug("[controle] audits payload (raw)", data);
        const sample = Array.isArray(data.items) ? data.items.slice(0,3) : [];
        console.debug("[controle] audits sample(3)", sample);
      }
      renderRows(data.items || []);
      qs("#status").textContent = `${data.count ?? (data.items?.length || 0)} evento(s) encontrado(s)`;
    }catch(e){
      console.error("[controle] network error on audits", e);
      qs("#status").textContent = "Erro de rede ao carregar.";
    } finally {
      console.groupEnd?.();
    }
  }

  function renderRows(items){
    const tbody = qs("#tbl tbody");
    tbody.innerHTML = "";
    if (DEBUG) console.groupCollapsed("[controle] renderRows", { count: items?.length || 0 });

    items?.forEach((row, i) => {
      const tr = document.createElement("tr");
      const alvo = `${esc(row.target_kind || "")} ${esc(row.target_id || "")}`.trim();
      const extra = row.extra ?? {};
      const filename = extra.filename || extra.filename_pdf || extra.filename_docx || "";
      const resultMeta = toObj(extra.result);
      const payloadMeta = toObj(extra.payload);
      const assuntoFinal =
        (extra.assunto || resultMeta.assunto || buildAssuntoFromPayload(payloadMeta) || extra.subject || "");
      const assuntoDisplay = assuntoFinal || (payloadMeta.objeto || extra.objeto || "");
      const sid = getSid(row);
      const canDownload = !!sid && String(row.action||"").toLowerCase() === "completed";

      if (DEBUG) {
        console.groupCollapsed(`[controle] row #${i+1}`, { id: row.id || null, ts: row.ts, action: row.action });
        console.debug("row", row);
        console.debug("extra", extra);
        console.debug("payloadMeta", payloadMeta);
        console.debug("resultMeta", resultMeta);
        console.debug("computed", { filename, assuntoFinal, assuntoDisplay, sid, canDownload, alvo });
        console.groupEnd();
      }

      tr.innerHTML = `
        <td class="nowrap">${fmtTs(row.ts)}</td>
        <td>${esc(row.username || "")}</td>
        <td>${esc(row.action || "")}</td>
        <td>${alvo || "—"}</td>
        <td>${esc(filename || "—")}</td>
        <td>${esc(assuntoDisplay || "—")}</td>
        <td>
          <div class="btn-row">
            ${canDownload ? `
              <button type="button" class="btn small" data-dl="pdf" aria-label="Baixar PDF">Baixar PDF</button>
              <button type="button" class="btn small secondary" data-dl="docx" aria-label="Baixar DOCX">Baixar DOCX</button>
            ` : `<span class="note">—</span>`}
          </div>
        </td>`;
      tbody.appendChild(tr);

      if (canDownload) {
        const pdfBtn = tr.querySelector('button[data-dl="pdf"]');
        const docxBtn = tr.querySelector('button[data-dl="docx"]');
        pdfBtn?.addEventListener('click', () => downloadFmt(sid, 'pdf'));
        docxBtn?.addEventListener('click', () => downloadFmt(sid, 'docx'));
      }
    });

    if (DEBUG) console.groupEnd();
  }

  function exportCsv(){
    const params = new URLSearchParams();
    const limit = Number(qs("#limit").value || 1000);
    const kind = qs("#kind").value.trim();
    const username = qs("#username").value.trim();
    const action = qs("#action").value.trim();
    const since = qs("#since").value;
    const until = qs("#until").value;

    if (limit) params.set("limit", String(limit));
    if (kind) params.set("kind", kind);
    if (username) params.set("username", username);
    if (action) params.set("action", action);
    if (since) params.set("since", toISO(since));
    if (until) params.set("until", toISO(until));

    const url = `/api/automations/controle/audits.csv?` + params.toString();
    if (DEBUG) console.debug("[controle] export CSV", url);
    window.open(url, "_blank");
  }

  function initDefaults(){
    const now = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const yyyy = now.getFullYear();
    const mm = pad(now.getMonth()+1);
    const dd = pad(now.getDate());
    qs("#since").value = `${yyyy}-${mm}-${dd}T00:00`;
    qs("#username").focus();
    if (DEBUG) console.info("[controle] initDefaults applied");
  }

  qs("#btnApply").addEventListener("click", load);
  qs("#btnCsv").addEventListener("click", exportCsv);

  async function bootstrap(){
    if (DEBUG) console.info("[controle] bootstrap starting…");
    await loadActions();
    initDefaults();
    await load();
    if (DEBUG) console.info("[controle] bootstrap done");
  }
  bootstrap();
</script>
</body>
</html>
