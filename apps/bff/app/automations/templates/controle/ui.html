<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Painel de Controle — Auditoria</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --pri:#2563eb; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Noto Color Emoji',sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .card { background:var(--card); border:1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding: 16px; }

  label { display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
  input:not([type="checkbox"]):not([type="radio"]), select { width: 100%; padding: 10px 12px; border:1px solid #cbd5e1; border-radius: 10px; font: inherit; background:#fff; }
  .row { display:flex; gap: 12px; }
  .col { flex:1; min-width: 0; }

  .actions { display:flex; gap: 12px; align-items:center; justify-content: space-between; }
  .btn { background: var(--pri); color:#fff; border:1px solid transparent; border-radius: 10px; padding: 10px 16px; cursor:pointer; transition:.16s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(2,6,23,.08); }
  .btn:focus-visible { outline: 2px solid #93c5fd; outline-offset: 2px; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.secondary:hover { background:#f8fafc; }
  .btn.small { padding: 8px 12px; font-size: 12px; }
  .note { font-size:12px; color:var(--muted); }
  .status { font-size:13px; color: var(--muted); }

  /* Full-bleed para a seção de eventos */
  .fullbleed {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    border-radius: 0;
    border-left: 0;
    border-right: 0;
  }

  /* Tabela */
  .table-wrap { overflow:auto; border:1px solid #e2e8f0; border-radius:12px; }
  table { width:100%; border-collapse: collapse; background:#fff; table-layout: fixed; }
  th, td { padding:10px 12px; border-bottom:1px solid #eef2f7; vertical-align: top; text-align:left; }
  th { font-size:12px; color:#64748b; background:#f8fafc; position:sticky; top:0; z-index:1; }
  tr:hover td { background:#fbfdff; }
  .nowrap { white-space: nowrap; }
  .wrap-any { overflow-wrap:anywhere; word-break:break-word; white-space:normal; }

  .btn-row { display:flex; gap:8px; flex-wrap: wrap; }
  .btn.ghost { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.ghost:hover { background:#f8fafc; }

  @media (max-width: 640px) {
    .actions { flex-direction: column; align-items: stretch; gap: 8px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Painel de Controle — Auditoria</h1>
    <span class="note">Somente leitura • Coordenadores/Admin</span>
  </div>

  <!-- Filtros -->
  <div class="card" aria-labelledby="filtros-title">
    <h2 id="filtros-title" style="font-size:16px; margin:0 0 8px">Filtros</h2>
    <div class="row">
      <div class="col">
        <label for="kind">Tipo (alvo)</label>
        <select id="kind">
          <option value="" selected>(Todos)</option>
          <option value="dfd">DFD</option>
          <option value="ferias">Férias</option>
        </select>
      </div>
      <div class="col">
        <label for="username">Servidor (nome ou CPF)</label>
        <input id="username" placeholder="Ex.: Maria, 12345678901" />
      </div>
      <div class="col">
        <label for="action">Ação/Status</label>
        <!-- será populado dinamicamente -->
        <select id="action">
          <option value="">(Todas)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="since">Desde</label>
        <input id="since" type="datetime-local" />
      </div>
      <div class="col">
        <label for="until">Até</label>
        <input id="until" type="datetime-local" />
      </div>
      <div class="col" style="max-width:180px">
        <label for="limit">Limite</label>
        <input id="limit" type="number" value="100" min="1" max="1000" />
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <span class="status" id="status" role="status" aria-live="polite"></span>
      <div>
        <button id="btnCsv" class="btn secondary small" type="button">Exportar CSV</button>
        <button id="btnApply" class="btn" type="button">Aplicar filtros</button>
      </div>
    </div>
  </div>
</div>

<!-- Resultados (full-bleed) -->
<div class="card fullbleed" style="margin-top:16px" aria-labelledby="result-title">
  <div class="wrap" style="max-width: 1440px;">
    <h2 id="result-title" style="font-size:16px; margin:0 0 8px">Eventos</h2>
    <div class="table-wrap">
      <table id="tbl" aria-describedby="status">
        <colgroup>
          <col style="width:160px"><!-- QUANDO -->
          <col style="width:220px"><!-- SERVIDOR -->
          <col style="width:160px"><!-- PROTOCOLO -->
          <col style="width:140px"><!-- ALVO -->
          <col style="width:260px"><!-- NOME DO ARQUIVO -->
          <col style="width:120px"><!-- STATUS -->
          <col style="width:220px"><!-- AÇÕES -->
        </colgroup>
        <thead>
          <tr>
            <th class="nowrap">QUANDO</th>
            <th>SERVIDOR</th>
            <th>PROTOCOLO</th>
            <th>ALVO</th>
            <th>NOME DO ARQUIVO</th>
            <th class="nowrap">STATUS</th>
            <th class="nowrap">AÇÕES</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="note" style="margin-top:8px">Dica: quando houver link disponível, os botões “baixar” e “ver” aparecem em AÇÕES.</div>
  </div>
</div>

<script>
  const qs = (sel) => document.querySelector(sel);

  function fmtTs(s){
    if(!s) return "";
    const d = new Date(s);
    return isNaN(d) ? String(s) : d.toLocaleString();
  }
  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }
  function toISO(dtLocalStr){
    if(!dtLocalStr) return "";
    const d = new Date(dtLocalStr);
    return isNaN(d) ? "" : d.toISOString();
  }

  async function loadActions(){
    const sel = qs("#action");
    const keep = sel.value; // caso usuário já tenha escolhido algo antes
    try{
      const r = await fetch(`/api/automations/controle/actions`, { credentials: "include" });
      if(!r.ok) throw new Error();
      const data = await r.json();
      const items = Array.isArray(data.items) ? data.items : [];
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = ""; optAll.textContent = "(Todas)";
      sel.appendChild(optAll);
      for(const a of items){
        const o = document.createElement("option");
        o.value = a; o.textContent = a;
        sel.appendChild(o);
      }
      // preferir 'completed' como padrão, a menos que já haja escolha anterior
      if (!keep) {
        if (items.includes("completed")) sel.value = "completed";
        else sel.value = ""; // fica em (Todas) se não houver
      } else {
        sel.value = keep;
      }
    }catch(_){
      // fallback com opções padrão e completed pré-setado
      const defaults = ["submitted","running","completed","failed","download"];
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = ""; optAll.textContent = "(Todas)";
      sel.appendChild(optAll);
      defaults.forEach(a=>{
        const o = document.createElement("option");
        o.value = a; o.textContent = a;
        sel.appendChild(o);
      });
      sel.value = "completed";
    }
  }

  function renderRow(it){
    const tr = document.createElement("tr");

    const quando = fmtTs(it.ts || it.created_at || it.updated_at);
    const servidor = it.username || "";
    const protocolo = it.protocolo || ((it.extra && (it.extra.protocolo || it.extra.processo || it.extra.process_number)) || "");
    const alvo = it.alvo || it.target_kind || ((it.extra && it.extra.kind) || "");
    const filename = it.filename || ((it.extra && it.extra.filename) || "");
    const status = it.status || it.action || "";

    const tdQuando = `<td class="nowrap">${esc(quando)}</td>`;
    const tdServidor = `<td class="wrap-any">${esc(servidor)}</td>`;
    const tdProtocolo = `<td class="wrap-any">${esc(protocolo || "—")}</td>`;
    const tdAlvo = `<td class="wrap-any">${esc(alvo || "—")}</td>`;
    const tdFile = `<td class="wrap-any">${esc(filename || "—")}</td>`;
    const tdStatus = `<td class="nowrap">${esc(status || "—")}</td>`;

    // Ações: usar URLs prontas do backend quando disponíveis
    const actions = [];
    if (it.download_url){
      const b = document.createElement("button");
      b.type="button"; b.className="btn small";
      b.textContent="baixar";
      b.addEventListener("click", ()=> doDownload(it.download_url, it.filename || "arquivo"));
      actions.push(b);
    }
    if (it.submission_url){
      const a = document.createElement("a");
      a.className="btn small secondary";
      a.textContent="ver";
      a.href = it.submission_url;
      a.target = "_blank"; a.rel = "noopener";
      actions.push(a);
    }
    const tdAcoes = document.createElement("td");
    tdAcoes.className = "nowrap";
    if (actions.length){
      const wrap = document.createElement("div");
      wrap.className = "btn-row";
      actions.forEach(el => wrap.appendChild(el));
      tdAcoes.appendChild(wrap);
    } else {
      tdAcoes.innerHTML = `<span class="note">—</span>`;
    }

    tr.innerHTML = tdQuando + tdServidor + tdProtocolo + tdAlvo + tdFile + tdStatus;
    tr.appendChild(tdAcoes);
    return tr;
  }

  async function doDownload(url, suggestedName){
    try{
      const r = await fetch(url, { method: 'POST', credentials: 'include' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      // tenta manter extensão se vier no nome
      const name = suggestedName && /\.[a-z0-9]{2,5}$/i.test(suggestedName) ? suggestedName : `arquivo_${Date.now()}`;
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    }catch(e){
      console.error("[controle] download error", e);
      alert('Não foi possível baixar o arquivo.');
    }
  }

  async function load(){
    const params = new URLSearchParams();
    const limit = Number(qs("#limit").value || 100);
    const kind = qs("#kind").value.trim();
    const username = qs("#username").value.trim();
    const action = qs("#action").value.trim();
    const since = qs("#since").value;
    const until = qs("#until").value;

    if (limit) params.set("limit", String(limit));
    if (kind) params.set("kind", kind);
    if (username) params.set("username", username);
    if (action) params.set("action", action);
    if (since) params.set("since", toISO(since));
    if (until) params.set("until", toISO(until));

    qs("#status").textContent = "Carregando...";

    try{
      const url = `/api/automations/controle/audits?` + params.toString();
      const resp = await fetch(url, { credentials: "include" });
      if(!resp.ok){
        const t = await resp.text();
        qs("#status").textContent = `Erro ${resp.status}: ${t}`;
        return;
      }
      const data = await resp.json();
      renderRows(data.items || []);
      qs("#status").textContent = `${data.count ?? (data.items?.length || 0)} evento(s) encontrado(s)`;
    }catch(e){
      qs("#status").textContent = "Erro de rede ao carregar.";
    }
  }

  function renderRows(rows){
    const tbody = document.querySelector("#tbl tbody");
    tbody.innerHTML = "";
    if(!rows || !rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="note">Nenhum registro.</td>`;
      tbody.appendChild(tr);
      return;
    }
    rows.forEach(r => tbody.appendChild(renderRow(r)));
  }

  function exportCsv(){
    const params = new URLSearchParams();
    const limit = Number(qs("#limit").value || 1000);
    const kind = qs("#kind").value.trim();
    const username = qs("#username").value.trim();
    const action = qs("#action").value.trim();
    const since = qs("#since").value;
    const until = qs("#until").value;

    if (limit) params.set("limit", String(limit));
    if (kind) params.set("kind", kind);
    if (username) params.set("username", username);
    if (action) params.set("action", action);
    if (since) params.set("since", toISO(since));
    if (until) params.set("until", toISO(until));

    const url = `/api/automations/controle/audits.csv?` + params.toString();
    window.open(url, "_blank");
  }

  function initDefaults(){
    const now = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const yyyy = now.getFullYear();
    const mm = pad(now.getMonth()+1);
    const dd = pad(now.getDate());
    qs("#since").value = `${yyyy}-${mm}-${dd}T00:00`;
    qs("#username").focus();
  }

  qs("#btnApply").addEventListener("click", load);
  qs("#btnCsv").addEventListener("click", exportCsv);

  async function bootstrap(){
    await loadActions();   // aqui já deixa 'completed' como default
    initDefaults();
    await load();          // primeira carga já virá com action=completed (quando disponível)
  }
  bootstrap();
</script>
</body>
</html>
