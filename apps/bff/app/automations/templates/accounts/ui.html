<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin — Contas & Roles</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --pri:#2563eb; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Noto Color Emoji',sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 1080px; margin: 24px auto; padding: 0 16px; }

  h1 { font-size: 20px; margin: 0 0 12px; }
  h2 { font-size: 16px; margin: 0 0 8px; display:flex; align-items:center; gap:8px; }

  .card { background:var(--card); border:1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding: 16px; }
  .muted { color: var(--muted); }

  label { display:block; font-size:12px; color:var(--muted); margin:12px 0 6px; }
  input, select { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; font:inherit; background:#fff; }
  input[type="search"] { appearance:none; }
  input::placeholder { color:#94a3b8; }

  .row { display:flex; gap:12px; align-items:stretch; }
  .row.center { align-items:center; }
  .col { flex:1; min-width:0; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  .btn { background: var(--pri); color:#fff; border:1px solid transparent; border-radius: 10px; padding: 10px 14px; cursor:pointer; transition:.16s ease; }
  .btn.small { padding:8px 10px; font-size:12px; }
  .btn.xs { padding:4px 8px; font-size:11px; border-radius:8px; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(2,6,23,.08); }
  .btn:focus-visible { outline: 2px solid #93c5fd; outline-offset: 2px; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.secondary:hover { background:#f8fafc; }
  .btn.danger { background:#b91c1c; }
  .btn.link { background:transparent; color:#1f2937; border:1px solid #e2e8f0; }
  .btn.icon { display:inline-flex; align-items:center; gap:6px; }
  .btn[disabled] { opacity:.6; cursor:not-allowed; box-shadow:none; transform:none; }

  .toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .toolbar .search { flex:1; }

  .badge { display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#1e3a8a; margin:2px 6px 2px 0; border:1px solid #e2e8f0; }
  .badge.super { background:#fde68a; color:#7c2d12; border-color:#fcd34d; }
  .badge.legacy { background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }

  .pill { display:inline-block; background:#eef2ff; color:#1e3a8a; border:1px solid #e2e8f0; padding:2px 8px; border-radius:999px; font-size:12px; margin:2px 6px 2px 0; }
  .pill.env { background:#f1f5f9; color:#334155; border-style:dashed; }
  .legend { font-size:12px; color:#64748b; margin:6px 0 2px; }

  .hr { height:1px; background:#e2e8f0; border:0; margin:16px 0; }

  table { width:100%; border-collapse: collapse; font-size: 14px; }
  .table-wrap { overflow-x:auto; -webkit-overflow-scrolling: touch; }
  .table-wrap table { min-width: 760px; }
  thead th { text-align:left; padding:10px 8px; border-bottom:1px solid #e2e8f0; color:#334155; font-weight:600; }
  tbody td { padding:10px 8px; border-bottom:1px solid #eef2f7; vertical-align: top; }
  tr:hover { background:#f8fafc; }

  .inline-help { display:inline-flex; align-items:center; position:relative; margin-left:6px; }
  .inline-help .help { width:18px; height:18px; border-radius:999px; background:#e2e8f0; color:#0f172a; border:1px solid #cbd5e1; font-size:12px; line-height:16px; text-align:center; padding:0; cursor:pointer; }
  .inline-help .help:hover { background:#dbeafe; border-color:#93c5fd; }
  .inline-help .tip { position:absolute; top:120%; left:0; z-index:10; min-width: 220px; max-width: 360px; background:#0f172a; color:#fff; padding:8px 10px; border-radius:10px; font-size:12px; box-shadow: 0 8px 24px rgba(2,6,23,.18); pointer-events:none; opacity:0; transform: translateY(-4px); transition: opacity .12s ease, transform .12s ease; }
  .inline-help:hover .tip, .inline-help:focus-within .tip { opacity:1; transform: translateY(0); }

  .banner { margin:10px 0 12px; padding:10px 12px; border-radius:12px; border:1px solid; font-size:14px; }
  .banner.warn { background:#fff7ed; color:#7c2d12; border-color:#fed7aa; }

  @media (max-width: 900px){
    .row { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="row center" style="justify-content:space-between; margin-bottom:10px">
    <h1>Admin — Contas & Roles</h1>
    <span class="muted" id="status" role="status" aria-live="polite"></span>
  </div>

  <!-- 1) Criar usuário — CARD CONDICIONAL (só aparece se legacy estiver habilitado) -->
  <div id="create_card" class="card" aria-labelledby="create-title" style="display:none">
    <h2 id="create-title">Criar usuário <span class="badge legacy">LEGADO</span></h2>
    <div id="legacy_banner" class="banner warn" role="status" aria-live="polite"></div>
    <div id="alerts"></div>

    <div class="row">
      <div class="col">
        <label for="cu_name">Nome completo
          <span class="inline-help">
            <button type="button" class="help" aria-label="Ajuda sobre Nome">?</button>
            <span class="tip">Mínimo 2 caracteres.</span>
          </span>
        </label>
        <input id="cu_name" placeholder="Ex.: Maria Souza" autocomplete="name"/>
      </div>
      <div class="col">
        <label for="cu_email">E-mail <span class="muted">(opcional)</span></label>
        <input id="cu_email" type="email" placeholder="voce@agepar.pr.gov.br" autocomplete="email"/>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="cu_cpf">CPF <span class="muted">(opcional)</span></label>
        <input id="cu_cpf" inputmode="numeric" pattern="[0-9]*" placeholder="00000000000" autocomplete="off"/>
      </div>
      <div class="col">
        <label for="cu_pwd">Senha</label>
        <div class="row">
          <input id="cu_pwd" type="password" placeholder="Mínimo 8 caracteres" autocomplete="new-password"/>
          <button class="btn secondary small" type="button" onclick="togglePwd()">Mostrar</button>
        </div>
      </div>
    </div>

    <label for="cu_roles">Roles (separados por vírgula)
      <span class="inline-help">
        <button type="button" class="help" aria-label="Ajuda sobre roles">?</button>
        <span class="tip">Ex.: <code>admin</code>, <code>automations.dfd</code>. É possível deixar em branco.</span>
      </span>
    </label>
    <input id="cu_roles" placeholder="admin, automations.dfd" autocomplete="off"/>

    <div class="btn-row" style="margin-top:12px">
      <button id="btn_create" class="btn" onclick="createUser()">Criar conta</button>
      <span id="cu_msg" class="muted" aria-live="polite"></span>
    </div>
  </div>

  <!-- 1b) Roles do sistema — CARD SEMPRE VISÍVEL -->
  <div class="card" style="margin-top:16px">
    <h2>Roles do sistema</h2>
    <div class="row" aria-label="Criar novo role">
      <input class="col" id="role_name" placeholder="nome do role ex.: automations.dfd" aria-label="Nome do role"/>
      <input class="col" id="role_desc" placeholder="descrição (opcional)" aria-label="Descrição do role"/>
      <button class="btn secondary" onclick="createRole()">Criar role</button>
    </div>
    <p class="muted" style="margin-top:8px">Existentes:
      <span class="inline-help">
        <button type="button" class="help" aria-label="Ajuda sobre roles do sistema">?</button>
        <span class="tip">O role <b>admin</b> é obrigatório para superusuários e não pode ser removido. Outros roles podem ser excluídos, mas os vínculos com usuários serão apagados.</span>
      </span>
    </p>
    <div id="roles_list" class="btn-row" aria-live="polite"></div>

    <div id="envdefaults_wrap" style="margin-top:12px; display:none">
      <p class="muted" style="margin:8px 0 6px">
        Herdadas do ambiente (somente leitura)
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre roles herdadas">?</button>
          <span class="tip">Estas roles vêm da configuração do ambiente (AUTH_DEFAULT_ROLES) e não são editáveis nesta tela.</span>
        </span>
      </p>
      <div id="env_defaults" class="btn-row" aria-live="polite"></div>
    </div>
  </div>

  <!-- 2) CRUD de contas (abaixo) -->
  <div class="card" style="margin-top:16px">
    <div class="toolbar">
      <input id="q" class="search" type="search" placeholder="Buscar por nome, email ou CPF…" aria-label="Buscar usuários" autocomplete="off"/>
      <div class="btn-row">
        <button class="btn secondary small" onclick="loadUsers()">Atualizar</button>
      </div>
    </div>
    <div class="table-wrap">
      <table aria-label="Usuários">
        <thead>
          <tr>
            <th>Nome</th><th>Email</th><th>CPF</th><th>Flags</th>
            <th>Roles
              <span class="inline-help">
                <button type="button" class="help" aria-label="Ajuda sobre roles na lista">?</button>
                <span class="tip">Mostramos as <b>Atribuídas (BD)</b> e as <b>Herdadas (ambiente)</b>. As herdadas não são editáveis aqui.</span>
              </span>
            </th>
            <th style="width:280px">Ações</th>
          </tr>
        </thead>
        <tbody id="users"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // -------------------------
  // Helpers UI
  // -------------------------
  function showAlert(kind, text){
    const el = document.getElementById('alerts');
    if(!el) return;
    const div = document.createElement('div');
    const base = "margin:8px 0; border-radius:10px; padding:8px 10px; font-size:14px; border:1px solid;";
    const byKind = kind==='ok'
      ? "background:#ecfdf5; color:#065f46; border-color:#a7f3d0"
      : "background:#fef2f2; color:#7f1d1d; border-color:#fecaca";
    div.setAttribute('role', kind==='ok'?'status':'alert');
    div.style = base + byKind;
    div.textContent = text;
    el.appendChild(div);
    setTimeout(()=>div.remove(), 4000);
  }
  function setStatus(text){ const s=document.getElementById('status'); if(s) s.textContent = text || ''; }
  function togglePwd(){
    const input = document.getElementById('cu_pwd');
    if(!input) return;
    input.type = input.type === 'password' ? 'text' : 'password';
  }

  function rolePill(name){ const span=document.createElement('span'); span.className='pill'; span.textContent=name; return span; }
  function rolePillEnv(name){ const span=document.createElement('span'); span.className='pill env'; span.textContent=name; return span; }

  // Config (roles herdadas do ambiente + legado criação)
  let ACC_CFG = { default_roles: [], legacy: { create_user: { enabled: false, since: '' } } };

  function applyLegacyUI(){
    const enabled = !!(ACC_CFG.legacy && ACC_CFG.legacy.create_user && ACC_CFG.legacy.create_user.enabled);
    const since = (ACC_CFG.legacy && ACC_CFG.legacy.create_user && ACC_CFG.legacy.create_user.since) || '';
    const card = document.getElementById('create_card');
    const banner = document.getElementById('legacy_banner');
    if(!card) return;

    if(enabled){
      card.style.display = 'block';
      if(banner){ banner.textContent = `Aviso: a criação de contas é um recurso LEGADO e será removida. Utilize preferencialmente o SSO/OIDC. ${since ? 'Desde: '+since : ''}`; }
    } else {
      // Mantém o card completamente oculto quando desabilitado
      card.style.display = 'none';
    }
  }

  async function loadConfig(){
    try{
      const r = await fetch('/api/automations/accounts/config');
      const j = await r.json();
      ACC_CFG.default_roles = j.default_roles || [];
      ACC_CFG.legacy = (j.legacy || { create_user: { enabled:false, since:'' } });

      const wrap = document.getElementById('envdefaults_wrap');
      const list = document.getElementById('env_defaults');
      if(list){ list.innerHTML = ''; }
      if ((ACC_CFG.default_roles||[]).length){
        ACC_CFG.default_roles.forEach(x=> list.appendChild(rolePillEnv(x)));
        if(wrap){ wrap.style.display = 'block'; }
      } else {
        if(wrap){ wrap.style.display = 'none'; }
      }
      applyLegacyUI();
    }catch(e){
      // Falha em /config => mantemos a criação oculta (display:none por padrão)
      applyLegacyUI();
    }
  }

  // -------------------------
  // CRUD — Users
  // -------------------------
  async function loadUsers(){
    const qEl = document.getElementById('q');
    const q = qEl ? qEl.value : '';
    setStatus('Carregando...');
    try{
      const resp = await fetch(`/api/automations/accounts/users?q=${encodeURIComponent(q||'')}`);
      const data = await resp.json();
      const tbody = document.getElementById('users');
      if(!tbody) return;
      tbody.innerHTML = '';
      for(const u of (data.items||[])){
        const tr = document.createElement('tr');

        // Flags (is_superuser não editável)
        const flags = document.createElement('div');
        if (u.is_superuser){ const b=document.createElement('span'); b.className='badge super'; b.textContent='superusuário'; flags.appendChild(b); }
        const rolesCell = document.createElement('td');
        const rolesWrap = document.createElement('div');
        const assigned = (u.roles||[]);
        const env = (u.roles_env || ACC_CFG.default_roles || []);
        // Atribuídas (BD)
        if (assigned.length){
          const legendA = document.createElement('div'); legendA.className='legend'; legendA.textContent='Atribuídas (BD):';
          rolesWrap.appendChild(legendA);
          const boxA = document.createElement('div');
          assigned.forEach(r => boxA.appendChild(rolePill(r)));
          rolesWrap.appendChild(boxA);
        }
        // Herdadas (ambiente)
        if (env.length){
          const legendE = document.createElement('div'); legendE.className='legend'; legendE.textContent='Herdadas (ambiente):';
          rolesWrap.appendChild(legendE);
          const boxE = document.createElement('div');
          env.forEach(r => boxE.appendChild(rolePillEnv(r)));
          rolesWrap.appendChild(boxE);
        }
        rolesCell.appendChild(rolesWrap);

        // Ações
        const actions = document.createElement('td');
        const row = document.createElement('div'); row.className='btn-row';
        const btnRoles = document.createElement('button'); btnRoles.className='btn secondary small'; btnRoles.textContent='Roles';
        btnRoles.onclick = () => promptRoles(u.id, (u.roles||[]).join(','));
        const btnPwd = document.createElement('button'); btnPwd.className='btn secondary small'; btnPwd.textContent='Senha';
        btnPwd.onclick = () => resetPwd(u.id);
        const btnDel = document.createElement('button'); btnDel.className='btn danger small'; btnDel.textContent='Excluir';
        btnDel.onclick = () => deleteUser(u.id);
        row.appendChild(btnRoles); row.appendChild(btnPwd); row.appendChild(btnDel);
        actions.appendChild(row);
        // Células seguras
        const tdName = document.createElement('td'); tdName.textContent = u.name || '';
        const tdEmail = document.createElement('td'); tdEmail.textContent = u.email || '';
        const tdCpf = document.createElement('td'); tdCpf.textContent = u.cpf || '';
        const tdFlags = document.createElement('td'); tdFlags.appendChild(flags);

        if ((assigned.length === 0) && (env.length === 0)) {
          const empty = document.createElement('div');
          empty.className = 'legend';
          empty.textContent = '— sem roles —';
          rolesWrap.appendChild(empty);
        }

        tr.appendChild(tdName);
        tr.appendChild(tdEmail);
        tr.appendChild(tdCpf);
        tr.appendChild(tdFlags);
        tr.appendChild(rolesCell);
        tr.appendChild(actions);
        tbody.appendChild(tr);
      }
    }catch(e){
      // evita crash de UI em caso de erro
    }finally{
      setStatus('');
    }
  }

  async function createUser(){
    // Segurança extra: se o card está oculto, não permite ação
    const card = document.getElementById('create_card');
    if(!card || card.style.display === 'none'){
      alert('Criação de contas desativada (LEGADO).');
      return;
    }

    const payload = {
      name: document.getElementById('cu_name').value.trim(),
      email: (document.getElementById('cu_email').value||'').trim() || null,
      cpf: (document.getElementById('cu_cpf').value||'').trim() || null,
      password: document.getElementById('cu_pwd').value,
      roles: (document.getElementById('cu_roles').value||'').split(',').map(s=>s.trim()).filter(Boolean)
    };

    if ((payload.name||'').length < 2) return alert('Nome deve ter ao menos 2 caracteres.');
    if (!payload.password || payload.password.length < 8) return alert('Senha deve ter no mínimo 8 caracteres.');
    if (!payload.email && !(payload.cpf && /^\d{11}$/.test(payload.cpf))) {
      return alert('Informe ao menos e-mail ou CPF (11 dígitos).');
    }

    const r = await fetch('/api/automations/accounts/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>({}));
    if(r.ok){
      alert('Usuário criado com sucesso. (Recurso LEGADO)');
      document.getElementById('cu_name').value='';
      document.getElementById('cu_email').value='';
      document.getElementById('cu_cpf').value='';
      document.getElementById('cu_pwd').value='';
      document.getElementById('cu_roles').value='';
      loadUsers();
      loadRoles();
    } else {
      alert(j.message || 'Erro ao criar usuário.');
      if (r.status === 410) {
        // backend desativou — esconde card imediatamente
        card.style.display = 'none';
      }
    }
  }

  async function promptRoles(userId, rolesCsv){
    const tip = "Dica: não é possível alterar a flag de superusuário por aqui.\nUse vírgulas para separar. Ex.: admin, automations.dfd";
    const current = rolesCsv || '';
    const next = prompt(`Informe os roles separados por vírgula:\n\n${tip}`, current);
    if(next===null) return;
    const roles = next.split(',').map(s=>s.trim()).filter(Boolean);
    const r = await fetch(`/api/automations/accounts/users/${userId}/roles`, {
      method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ roles })
    });
    if(r.ok){ 
      loadUsers(); 
      loadRoles();
    } else {
      const j = await r.json().catch(()=>({}));
      alert(j?.detail || j?.message || 'Erro ao definir roles');
    }
  }

  async function resetPwd(userId){
    const p = prompt('Nova senha (mín. 8 caracteres):');
    if(!p) return;
    if (p.length < 8) return alert('A senha precisa ter no mínimo 8 caracteres.');
    const r = await fetch(`/api/automations/accounts/users/${userId}/password`, {
      method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password:p })
    });
    if(r.ok){ alert('Senha alterada.'); } else { alert('Erro ao alterar senha.'); }
  }

  async function deleteUser(userId){
    if(!confirm('Tem certeza que deseja excluir o usuário? Esta ação é irreversível.')) return;
    const url = `/api/automations/accounts/users/${encodeURIComponent(userId)}`;
    const r = await fetch(url, { method:'DELETE' });
    if(r.ok){ 
      loadUsers(); 
      loadRoles();
    } else {
      const j = await r.json().catch(()=>({}));
      alert(j?.detail || j?.message || 'Erro ao excluir.');
    }
  }

  // -------------------------
  // Roles
  // -------------------------
  async function createRole(){
    const name = document.getElementById('role_name').value.trim();
    const description = document.getElementById('role_desc').value.trim()||null;
    if(!name) return alert('Informe o nome do role.');
    const r = await fetch('/api/automations/accounts/roles', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, description })
    });
    if(r.ok){
      alert('Role criado.');
      document.getElementById('role_name').value=''; document.getElementById('role_desc').value='';
      loadRoles();
    } else {
      const j = await r.json().catch(()=>({}));
      alert(j.message || 'Erro ao criar role.');
    }
  }

  async function deleteRole(roleName){
    if(!roleName) return;
    if(roleName === 'admin'){ return alert("Não é permitido remover o role 'admin'."); }
    if(!confirm(`Remover o role "${roleName}"? Os vínculos com usuários serão apagados.`)) return;
    const url = `/api/automations/accounts/roles/${encodeURIComponent(roleName)}`;
    const r = await fetch(url, { method:'DELETE' });
    if(r.ok){
      alert(`Role "${roleName}" removido.`);
      loadRoles();
      loadUsers();
    } else {
      const j = await r.json().catch(()=>({}));
      alert(j?.detail || j?.message || `Erro ao remover role "${roleName}".`);
    }
  }

  async function loadRoles(){
    const r = await fetch('/api/automations/accounts/roles');
    const j = await r.json();
    const el = document.getElementById('roles_list');
    if(!el) return;
    el.innerHTML = '';
    (j.items||[]).forEach(x=>{
      const wrap = document.createElement('span'); wrap.className='badge'; wrap.title = x.description || '';
      const label = document.createElement('span'); label.textContent = x.name;
      const del = document.createElement('button');
      del.className = 'btn xs danger';
      del.type = 'button';
      del.setAttribute('aria-label', `Excluir role ${x.name}`);
      del.textContent = 'Excluir';
      del.onclick = () => deleteRole(x.name);
      wrap.appendChild(label);
      if(x.name !== 'admin'){ wrap.appendChild(del); } // UI também protege admin
      el.appendChild(wrap);
    });
  }

  // debounce da busca
  function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const qEl = document.getElementById('q');
  if(qEl) qEl.addEventListener('input', debounce(loadUsers, 250));

  // boot
  loadConfig().then(()=>{ loadUsers(); });
  loadRoles();
</script>
</body>
</html>