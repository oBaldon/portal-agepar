<!doctype html>
<html lang="pt-BR"><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DFD — Documento de Formalização da Demanda (MVP)</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --pri:#2563eb; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Noto Color Emoji',sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .card { background:var(--card); border:1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding: 16px; }
  label { display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
  input, textarea, select { width: 100%; padding: 10px 12px; border:1px solid #cbd5e1; border-radius: 10px; font: inherit; background:#fff; }
  textarea { min-height: 100px; resize: vertical; }
  .row { display:flex; gap: 12px; }
  .col { flex:1; min-width: 0; }
  .actions { display:flex; gap: 12px; align-items:center; }
  .btn { background: var(--pri); color:#fff; border:1px solid transparent; border-radius: 10px; padding: 10px 16px; cursor:pointer; transition:.16s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(2,6,23,.08); }
  .btn:focus-visible { outline: 2px solid #93c5fd; outline-offset: 2px; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.secondary:hover { background:#f8fafc; }
  .btn.small { padding: 8px 12px; font-size: 12px; }
  .btn[disabled] { opacity:.6; cursor: not-allowed; transform:none; box-shadow:none; }
  .btn-row { display:flex; gap:10px; flex-wrap:wrap; }
  .note { font-size:12px; color:var(--muted); }
  .status { margin-top:12px; font-size:13px; }
  .list { margin-top: 24px; }
  .item { padding:12px; border:1px dashed #e2e8f0; border-radius: 10px; margin-bottom: 8px; background:#fff; }
  .item .meta { margin-bottom:8px; }
  .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius: 999px; background:#eef2ff; color:#1e3a8a; margin-right:6px; }

  /* help / tooltip */
  .inline-help { display:inline-flex; align-items:center; position:relative; margin-left:6px; }
  .inline-help .help {
    width:18px; height:18px; border-radius:999px; background:#e2e8f0; color:#0f172a;
    border:1px solid #cbd5e1; font-size:12px; line-height:16px; text-align:center;
    padding:0; cursor:pointer;
  }
  .inline-help .help:hover { background:#dbeafe; border-color:#93c5fd; }
  .inline-help .help:focus-visible { outline:2px solid #93c5fd; outline-offset:2px; }
  .inline-help .tip {
    position:absolute; top:120%; left:0; z-index:10; min-width: 220px; max-width: 360px;
    background:#0f172a; color:#fff; padding:8px 10px; border-radius:10px; font-size:12px;
    box-shadow: 0 8px 24px rgba(2,6,23,.18); pointer-events:none;
    opacity:0; transform: translateY(-4px); transition: opacity .12s ease, transform .12s ease;
  }
  .inline-help:hover .tip, .inline-help:focus-within .tip { opacity:1; transform: translateY(0); }
  .tip code { background: rgba(255,255,255,.12); padding:0 4px; border-radius:4px; }
</style>

<div class="wrap">
  <div class="header">
    <h1>DFD — Documento de Formalização da Demanda (MVP)</h1>
    <a class="btn secondary small"
   href="/api/automations/dfd/ui/history">Meus DFDs</a>

  </div>

  <div class="card">
    <form id="f">
      <div class="row">
        <div class="col">
          <label>
            Diretoria
            <span class="inline-help">
              <button type="button" class="help" aria-label="Ajuda sobre Diretoria">!</button>
              <span class="tip">Selecione o timbre/cabeçalho correspondente. As opções vêm de <code>/templates/dfd_models</code>.</span>
            </span>
          </label>
          <select name="modeloSlug" id="modeloSlug" required>
            <option value="">-- Selecionar --</option>
          </select>
          <div class="note">Carrega pastas de /templates/dfd_models.</div>
        </div>

        <div class="col">
          <label>
            Nº do memorando
            <span class="inline-help">
              <button type="button" class="help" aria-label="Ajuda sobre Nº do memorando">!</button>
              <span class="tip">Use o padrão da sua unidade (ex.: <code>012/2025</code>). Esse número aparece no cabeçalho.</span>
            </span>
          </label>
          <input name="numero" placeholder="Ex.: 0XX/202X" required />
        </div>
      </div>

      <label>
        Objeto
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Objeto">!</button>
          <span class="tip">Digite apenas o objeto (ex.: <em>Aquisição de software X</em>). O assunto final será montado como <code>DFD - PCA [ano] - [objeto]</code>.</span>
        </span>
      </label>
      <input name="assunto" placeholder="Ex.: Aquisição de software X" required />
      <div class="note">O assunto final será montado automaticamente como <code>DFD - PCA [ano] - [objeto]</code>.</div>

      <label>
        Ano de execução do PCA
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Ano de execução do PCA">!</button>
          <span class="tip">Informe 4 dígitos (ex.: <code>2025</code>). É usado no cabeçalho e no texto introdutório.</span>
        </span>
      </label>
      <input
        name="pcaAno"
        placeholder="Ex.: 2025"
        inputmode="numeric"
        minlength="4"
        maxlength="4"
        pattern="[0-9]{4}"
        required
        />

      <label>
        Exemplo 1
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Exemplo 1">!</button>
          <span class="tip">Campo livre. Cada quebra de linha será respeitada no documento final.</span>
        </span>
      </label>
      <textarea name="exemplo1"></textarea>

      <label>
        Exemplo 2
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Exemplo 2">!</button>
          <span class="tip">Campo livre. Utilize para detalhar justificativas, escopo, etc.</span>
        </span>
      </label>
      <textarea name="exemplo2"></textarea>

      <label>
        Exemplo 3
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Exemplo 3">!</button>
          <span class="tip">Campo livre. Pode ser usado para referências, prazos, anexos relacionados.</span>
        </span>
      </label>
      <textarea name="exemplo3"></textarea>

      <div class="actions" style="margin-top:16px">
        <button class="btn" id="submitBtn">Gerar DFD</button>
        <span class="status" id="status" aria-live="polite"></span>
      </div>
    </form>
  </div>

  <div class="list" id="subs"></div>
</div>

<script>
  const f = document.getElementById('f');
  const statusEl = document.getElementById('status');
  const subsEl = document.getElementById('subs');
  const submitBtn = document.getElementById('submitBtn');
  const modeloSel = document.getElementById('modeloSlug');

  async function loadModels(){
    try {
      const r = await fetch('./models');
      if (!r.ok) return;
      const data = await r.json();
      const items = (data && data.items) || [];
      items.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.slug;
        opt.textContent = m.slug;
        modeloSel.appendChild(opt);
      });
    } catch(e) {}
  }

  function formToPayload(form) {
    const data = new FormData(form);
    const obj = Object.fromEntries(data.entries());
    return obj;
  }

  async function submit(evt) {
    evt.preventDefault();
    submitBtn.disabled = true;
    statusEl.textContent = 'Enviando...';

    const payload = formToPayload(f);

    const res = await fetch('./submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) {
      let msg = (data && data.message) ? data.message : String(res.status);
      const details = (data && data.details && data.details.errors);
      if (Array.isArray(details) && details.length) {
        msg += ' — ' + details.join(' | ');
      }
      statusEl.textContent = 'Erro: ' + msg;
      submitBtn.disabled = false;
      return;
    }

    statusEl.textContent = 'Fila criada, aguardando processamento...';
    const sid = data.submissionId;
    let tries = 0;
    let row = null;
    while (tries < 120) {
      await new Promise(r => setTimeout(r, 1000));
      const r = await fetch('./submissions/' + sid);
      row = await r.json();
      if (row.status === 'done' || row.status === 'error') break;
      tries++;
    }
    if (!row) {
      statusEl.textContent = 'Falha ao acompanhar processamento.';
      submitBtn.disabled = false;
      return;
    }

    if (row.status === 'done') {
      statusEl.textContent = 'Pronto! Download do arquivo abaixo.';
      const div = document.createElement('div');
      div.className = 'item';

      const toObj = (x) => {
        if (!x) return {};
        if (typeof x === 'string') { try { return JSON.parse(x); } catch { return {}; } }
        if (typeof x === 'object') return x;
        return {};
      };

      const d = toObj(row.result);

      // exibe nome sem extensão
      const displayName = (() => {
        const n = (d.filename || d.filename_pdf || d.filename_docx || '').trim();
        const i = n.lastIndexOf('.');
        return i > 0 ? n.slice(0, i) : n;
      })();

      const meta = document.createElement('div');
      meta.className = 'meta';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = 'done';

      const when = new Date(d.generated_at || Date.now()).toLocaleString();
      const title = document.createElement('span');
      title.textContent = ` ${displayName} — ${when}`;

      meta.appendChild(badge);
      meta.appendChild(title);

      const buttons = document.createElement('div');
      buttons.className = 'btn-row';

      // Botão PDF (se existir)
      if (d.filename_pdf && d.file_path_pdf) {
        const btnPdf = document.createElement('button');
        btnPdf.type = 'button';
        btnPdf.className = 'btn';
        btnPdf.textContent = 'Baixar PDF';
        btnPdf.onclick = async () => {
          try {
            const dl = await fetch('./submissions/' + sid + '/download/pdf', { method: 'POST' });
            if (!dl.ok) throw new Error('Falha no download (PDF)');
            const blob = await dl.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (d.filename_pdf || ('dfd_' + sid + '.pdf'));
            a.click();
            URL.revokeObjectURL(a.href);
          } catch (e) {
            alert('Não foi possível baixar o PDF.');
          }
        };
        buttons.appendChild(btnPdf);
      }

      // Botão DOCX (sempre deve existir)
      const btnDocx = document.createElement('button');
      btnDocx.type = 'button';
      btnDocx.className = 'btn secondary';
      btnDocx.textContent = 'Baixar DOCX';
      btnDocx.onclick = async () => {
        try {
          const dl = await fetch('./submissions/' + sid + '/download/docx', { method: 'POST' });
          if (!dl.ok) throw new Error('Falha no download (DOCX)');
          const blob = await dl.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (d.filename_docx || ('dfd_' + sid + '.docx'));
          a.click();
          URL.revokeObjectURL(a.href);
        } catch (e) {
          alert('Não foi possível baixar o DOCX.');
        }
      };
      buttons.appendChild(btnDocx);

      div.appendChild(meta);
      div.appendChild(buttons);
      subsEl.prepend(div);
    } else {
      statusEl.textContent = 'Erro ao gerar: ' + (row.error || 'desconhecido');
    }
    submitBtn.disabled = false;
  }

  loadModels();
  f.addEventListener('submit', submit);
</script>
