<!doctype html>
<html lang="pt-BR">
<head>
<!-- UI DFD -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DFD — Documento de Formalização da Demanda</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --pri:#2563eb; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Noto Color Emoji',sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .card { background:var(--card); border:1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding: 16px; }

  .hidden { display:none !important; }

  label { display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
  input:not([type="checkbox"]):not([type="radio"]), textarea, select { width: 100%; padding: 10px 12px; border:1px solid #cbd5e1; border-radius: 10px; font: inherit; background:#fff; }
  textarea { min-height: 100px; resize: vertical; }
  .row { display:flex; gap: 12px; }
  .col { flex:1; min-width: 0; }

  .actions { display:flex; gap: 12px; align-items:center; justify-content: space-between; }
  .btn { background: var(--pri); color:#fff; border:1px solid transparent; border-radius: 10px; padding: 10px 16px; cursor:pointer; transition:.16s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(2,6,23,.08); }
  .btn:focus-visible { outline: 2px solid #93c5fd; outline-offset: 2px; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.secondary:hover { background:#f8fafc; }
  .btn.small { padding: 8px 12px; font-size: 12px; }
  .btn.danger { background:#b91c1c; }
  .btn[disabled] { opacity:.6; cursor: not-allowed; transform:none; box-shadow:none; }
  .btn-row { display:flex; gap:10px; flex-wrap:wrap; }

  .note { font-size:12px; color:var(--muted); }
  .status { font-size:13px; color: var(--muted); }
  .list { margin-top: 24px; }

  .item { position: relative; padding:12px; padding-bottom: 64px; border:1px dashed #e2e8f0; border-radius: 10px; margin-bottom: 12px; background:#fff; }
  .item .meta { display:flex; justify-content:flex-start; align-items:center; margin-bottom:8px; gap:8px; }
  .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius: 999px; background:#eef2ff; color:#1e3a8a; margin-right:6px; }

  .inline-help { display:inline-flex; align-items:center; position:relative; margin-left:6px; }
  .inline-help .help { width:18px; height:18px; border-radius:999px; background:#e2e8f0; color:#0f172a; border:1px solid #cbd5e1; font-size:12px; line-height:16px; text-align:center; padding:0; cursor:pointer; }
  .inline-help .help:hover { background:#dbeafe; border-color:#93c5fd; }
  .inline-help .help:focus-visible { outline:2px solid #93c5fd; outline-offset: 2px; }
  .inline-help .tip { position:absolute; top:120%; left:0; z-index:10; min-width: 220px; max-width: 360px; background:#0f172a; color:#fff; padding:8px 10px; border-radius:10px; font-size:12px; box-shadow: 0 8px 24px rgba(2,6,23,.18); pointer-events:none; opacity:0; transform: translateY(-4px); transition: opacity .12s ease, transform .12s ease; }
  .inline-help:hover .tip, .inline-help:focus-within .tip { opacity:1; transform: translateY(0); }
  .tip code { background: rgba(255,255,255,.12); padding:0 4px; border-radius:4px; }

  .req-star { color:#dc2626; font-weight:700; margin-left:4px; }
  .req-legend { display:flex; align-items:center; gap:6px; margin: 8px 0 12px; }
  .group-disabled .req-star { color:#94a3b8; }

  .hr { height:1px; background:#e2e8f0; border:0; margin:12px 0; }

  input[disabled], textarea[disabled], select[disabled] { background:#f1f5f9; color:#64748b; border-color:#e2e8f0; cursor:not-allowed; }
  input.readonly, textarea.readonly { background:#f1f5f9; color:#64748b; border-color:#e2e8f0; }
  .group-disabled label { color:#94a3b8; }
  .group-disabled .inline-help .help { background:#e5e7eb; color:#94a3b8; border-color:#e5e7eb; }
  .group-disabled input:not([type="checkbox"]):not([type="radio"]), .group-disabled select, .group-disabled textarea { background:#f1f5f9; color:#64748b; border-color:#e2e8f0; }

  .item-actions { position:absolute; right:12px; bottom:12px; display:flex; gap:8px; }
  .checkline { display:flex; align-items:center; gap:8px; padding:6px 0; }
  .checkline input[type="checkbox"] { width:auto; margin:0; }
  .checkline label { margin:0; font-size:12px; color:var(--muted); }

  .banner {
    border:1px solid #f59e0b;
    background:#fffbeb;
    color:#92400e;
    border-radius: 12px;
    padding: 10px 12px;
    margin: 12px 0;
    font-size: 13px;
    display:flex;
    align-items:flex-start;
    gap:10px;
  }
  .banner strong { color:#7c2d12; }

  .pe-box { border:1px dashed #cbd5e1; border-radius: 12px; padding: 12px; background: #ffffff; }
  .pe-selected { display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
  .pe-item { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding: 10px 12px; border:1px solid #e2e8f0; border-radius: 12px; background:#f8fafc; }
  .pe-item .txt { font-size: 13px; color: var(--fg); line-height: 1.35; }
  .pe-item .meta { display:flex; gap:8px; align-items:center; }
  .pe-item .tag { font-size: 12px; color: var(--muted); background:#ffffff; border:1px solid #e2e8f0; padding: 3px 8px; border-radius: 999px; }
  .pe-item .rm { white-space: nowrap; }
  .pe-msg { margin-top: 10px; font-size: 13px; color:#b91c1c; }

  textarea.bigtext { min-height: 280px; }

  .cap-box { border:1px dashed #cbd5e1; border-radius: 12px; padding: 12px; background:#fff; margin-top: 10px; }
  .cap-box h3 { margin:0 0 6px; font-size: 13px; }
  .cap-checks { display:flex; flex-direction:column; gap:8px; margin-top: 8px; }
  .cap-check { display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid #e2e8f0; border-radius: 12px; background:#f8fafc; cursor:pointer; }
  .cap-check input { width:auto; margin-top: 2px; }
  .cap-check .txt { font-size: 13px; color: var(--fg); line-height: 1.35; }
  .cap-check .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

  @keyframes shake { from{transform:translateX(0)} 33%{transform:translateX(-2px)} 66%{transform:translateX(2px)} to{transform:translateX(0)} }
  @media (max-width: 640px) {
    .row { flex-direction: column; }
    .actions { flex-direction: column; align-items: stretch; gap: 8px; }
    .actions .btn-row { justify-content: flex-end; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>DFD — Documento de Formalização da Demanda</h1>
    <a class="btn secondary small" href="/api/automations/dfd/ui/history">Meus DFDs</a>
  </div>

  <div class="card">
    <form id="f" novalidate>
      <div class="note req-legend">
        <span class="req-star" aria-hidden="true">*</span>
        <span>Campos obrigatórios.</span>
      </div>

      <div class="row">
        <div class="col">
          <label for="modeloSlug">Timbre
            <span class="inline-help">
              <button type="button" class="help" aria-label="Ajuda sobre Timbre">?</button>
              <span class="tip">Selecione o timbre/cabeçalho do documento.</span>
            </span>
          </label>
          <select name="modeloSlug" id="modeloSlug" required>
            <option value="">-- Selecionar --</option>
          </select>
        </div>

        <div class="col">
          <label for="numero">Nº do memorando
            <span class="inline-help">
              <button type="button" class="help" aria-label="Ajuda sobre Nº do memorando">?</button>
              <span class="tip">Use o padrão da sua diretoria (ex.: <code>012/2025</code>).</span>
            </span>
          </label>
          <input id="numero" name="numero" placeholder="Ex.: 0XX/202X" required />
        </div>
      </div>

      <label for="assunto">Assunto
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Assunto">?</button><span class="tip">Assunto exibido no cabeçalho do documento.</span></span>
      </label>
      <input id="assunto" name="assunto" placeholder="Ex.: Aquisição de software X" required />

      <label for="pcaAno">Ano de execução do PCA
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Ano de execução do PCA">?</button><span class="tip">Ano: Informe 4 dígitos.</span></span>
      </label>
      <input name="pcaAno" id="pcaAno" placeholder="Ex.: 2027" inputmode="numeric" minlength="4" maxlength="4" pattern="[0-9]{4}" required />

      <label for="diretoriaDemandante">Diretoria demandante
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Diretoria demandante">?</button><span class="tip">Selecione a diretoria requerente da demanda.</span></span>
      </label>
      <select name="diretoriaDemandante" id="diretoriaDemandante" required>
        <option value="">-- Selecionar --</option>
      </select>

      <label>Alinhamento com o <em>Planejamento Estratégico</em>
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Alinhamento">?</button>
          <span class="tip">Selecione um <strong>Pilar</strong> e um <strong>Objetivo Estratégico</strong> e clique em “Adicionar”. Você pode adicionar mais de um objetivo (sem repetir).</span>
        </span>
      </label>

      <div class="pe-box">
        <div class="row">
          <div class="col">
            <label for="pePilar">Pilar</label>
            <select id="pePilar">
              <option value="">-- Selecionar --</option>
            </select>
          </div>

          <div class="col">
            <label for="peObjetivo">Objetivo estratégico</label>
            <select id="peObjetivo" disabled>
              <option value="">-- Selecionar --</option>
            </select>
          </div>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button type="button" class="btn secondary small" id="peAdd">Adicionar alinhamento</button>
        </div>

        <div id="peMsg" class="pe-msg" role="status" aria-live="polite"></div>
        <div id="peSelected" class="pe-selected" aria-live="polite"></div>

        <input type="hidden" name="alinhamentoPE" id="alinhamentoPE" value="" />

        <div class="note" style="margin-top:8px;">
          Exemplo: “Está alinhado ao Planejamento Estratégico da Agepar 2026-2029 – Pilar 2 - Objetivo estratégico 2: Reduzir conflitos internos e otimizar fluxos de trabalho.”
        </div>
      </div>

      <label for="justificativaNecessidade">Justificativa da necessidade
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Justificativa da necessidade">?</button><span class="tip">Por que a demanda é necessária.</span></span>
      </label>
      <textarea name="justificativaNecessidade" id="justificativaNecessidade" placeholder="Contexto e motivação da demanda" required></textarea>

      <div id="reajustePcaBox"></div>

      <label for="objeto">Objeto
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Objeto">?</button><span class="tip">Descreva o objeto da contratação.</span></span>
      </label>
      <textarea name="objeto" id="objeto" placeholder="Ex.: Licenças do sistema Z" required></textarea>

      <div class="checkline" id="objetoUmItemBox">
        <input type="checkbox" id="objetoUmItem" />
        <label for="objetoUmItem">O objeto possui <strong>apenas</strong> 1 item?</label>
      </div>

      <hr class="hr" />

      <div id="capItemsBox"></div>

      <h2 id="itemsTitle" style="font-size:16px; margin:0 0 8px">Itens</h2>
      <div class="note" id="itemsNote">Adicione um ou mais itens. Cada item possui seus próprios campos.</div>
      <div id="items"></div>

      <hr class="hr" />

      <div id="prazosGroup">
        <label for="prazosEnvolvidos">Prazos envolvidos
          <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Prazos envolvidos">?</button><span class="tip">Selecione “mês de AAAA”.</span></span>
        </label>
        <select name="prazosEnvolvidos" id="prazosEnvolvidos" disabled required>
          <option value="">Informe o ano do PCA primeiro</option>
        </select>
      </div>

      <label for="consequenciaNaoAquisicao">Consequência da não aquisição
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Consequência da não aquisição">?</button><span class="tip">Impactos se não contratar.</span></span>
      </label>
      <textarea name="consequenciaNaoAquisicao" id="consequenciaNaoAquisicao" placeholder="Descreva as consequências" required></textarea>

      <label for="grauPrioridade">Grau de prioridade
        <span class="inline-help"><button type="button" class="help" aria-label="Ajuda sobre Grau de prioridade">?</button><span class="tip">Selecione conforme impacto.</span></span>
      </label>
      <select name="grauPrioridade" id="grauPrioridade" required>
        <option value="">-- Selecionar --</option>
      </select>

      <label for="protocolo">Protocolo
        <span class="inline-help">
          <button type="button" class="help" aria-label="Ajuda sobre Protocolo">?</button>
          <span class="tip">Informe o número de protocolo (ex.: <code>17.123.456-7</code>). Campo obrigatório para gerar o DFD.</span>
        </span>
      </label>
      <input id="protocolo" name="protocolo" placeholder="Ex.: 17.123.456-7" maxlength="100" required />

      <div class="actions" style="margin-top:16px">
        <span class="status" id="status" role="status" aria-live="polite"></span>
        <div class="btn-row">
          <button type="submit" class="btn" id="submitBtn" disabled aria-disabled="true" title="Informe o Protocolo e selecione ao menos 1 objetivo estratégico para gerar o DFD">Gerar DFD</button>
        </div>
      </div>
    </form>
  </div>

  <div class="list" id="subs"></div>
</div>

<script>
  const LISTS = {
    unidadeMedida: ["Caixa","Caloria","Cartela","Cartucho","Dose","Dúzia","Frasco","Grama","Kit","Litro","Mês","Metro","Metro cúbico","Metro linear","Metro quadrado","Milheiro","Miligrama","Mililitro","Outras Unidades de Medidas","Par","Quilograma","Quilograma do peso drenado","Quilômetro","Rolo","Teste","Tubo","Unidade Internacional","Unitário"],
    grauPrioridade: [
      "Alto, quando a impossibilidade de contratação provoca interrupção de processo crítico ou estratégico.",
      "Médio, quando a impossibilidade de contratação provoca atraso de processo crítico ou estratégico.",
      "Baixo, quando a impossibilidade de contratação provoca interrupção ou atraso de processo não crítico.",
      "Muito baixo, quando a continuidade do processo é possível mediante o emprego de uma solução de contorno."
    ],
    simNao: ["Sim","Não"],
    diretoriasDemandantes: [
      "Diretoria da Presidência - DP",
      "Diretoria Administrativa e Financeira - DAF",
      "Diretoria de Regulação Econômica - DRE",
      "Diretoria de Fiscalização e Qualidade de Serviços - DFQS",
      "Diretoria de Normas e Regulamentação - DNR",
    ]
  };

  const PE_2026_2029 = [
    { n: 1, label: "Pilar 1 – Regulação, Fiscalização e Normatização", objetivos: [
      "Expandir o uso de recursos tecnológicos na regulação e fiscalização.",
      "Contratar apoio operacional ou parcerias entre entidades públicas para as áreas de fiscalização e regulação.",
      "Elaborar estratégia específica para o mercado de resíduos sólidos e drenagem e manejo de águas pluviais.",
      "Ampliar a presença da Agepar junto à sociedade mediante o incremento das ações de fiscalização em campo"
    ]},
    { n: 2, label: "Pilar 2 – Autonomia Técnica e Administrativa", objetivos: [
      "Fortalecer a Independência Institucional, a Integridade e a Transparência da Agepar.",
      "Reduzir conflitos internos e otimizar fluxos de trabalho."
    ]},
    { n: 3, label: "Pilar 3 – Gestão & Governança Corporativa Sustentável", objetivos: [
      "Consolidar a cultura de Governança Sustentável Ambiental e Social interna da Agepar.",
      "Otimizar a comunicação interna, promover o engajamento dos servidores e a cultura de Governança Sustentável Ambiental e Social.",
      "Impulsionar a modernização tecnológica."
    ]}
  ];

  const f = document.getElementById('f');
  const statusEl = document.getElementById('status');
  const subsEl = document.getElementById('subs');
  const submitBtn = document.getElementById('submitBtn');
  const modeloSel = document.getElementById('modeloSlug');
  const pcaAnoEl = document.getElementById('pcaAno');
  const itemsEl = document.getElementById('items');
  const itemsNoteEl = document.getElementById('itemsNote');
  const itemsTitleEl = document.getElementById('itemsTitle');
  const dirDemSel = document.getElementById('diretoriaDemandante');
  const objetoEl = document.getElementById('objeto');
  const objetoUmItemEl = document.getElementById('objetoUmItem');
  const objetoUmItemBoxEl = document.getElementById('objetoUmItemBox');
  const prazosSel = document.getElementById('prazosEnvolvidos');
  const prazosGroup = document.getElementById('prazosGroup');
  const prazosTipEl = prazosGroup?.querySelector('.inline-help .tip') || null;

  function applyPrazosTip(){
    if(!prazosTipEl) return;
    // tip padrão (para DFD padrão)
    prazosTipEl.textContent = 'Selecione “mês de AAAA”.';
    // tip específico (apenas capacitação)
    if(__IS_CAP__){
      prazosTipEl.textContent = 'No modo capacitação, o prazo é fixo: “dezembro de AAAA”.';
    }
  }

  const consequenciaEl = document.getElementById('consequenciaNaoAquisicao');
  const protocoloEl = document.getElementById('protocolo');
  const reajustePcaBox = document.getElementById('reajustePcaBox');
  const capItemsBoxEl = document.getElementById('capItemsBox');

  const justificativaNecessidadeEl = document.getElementById('justificativaNecessidade');

  const pePilarEl = document.getElementById('pePilar');
  const peObjetivoEl = document.getElementById('peObjetivo');
  const peAddBtn = document.getElementById('peAdd');
  const peSelectedEl = document.getElementById('peSelected');
  const peMsgEl = document.getElementById('peMsg');
  const alinhamentoEl = document.getElementById('alinhamentoPE');

  let __CONFIG_LOADED__ = false;
  let __REAJUSTE_PCA_ATIVO__ = false;

  function getTipoFromQuery(){
    try{
      const sp = new URLSearchParams(window.location.search || "");
      const t = (sp.get("tipo") || "").toLowerCase().trim();
      return (t === "capacitacao" || t === "padrao") ? t : "";
    }catch(_e){
      return "";
    }
  }
  const __TIPO__ = getTipoFromQuery();
  const __IS_CAP__ = (__TIPO__ === "capacitacao");

  const DEFAULT_JUSTIFICATIVA_CAP = `A atuação da Agepar demanda elevado grau de especialização técnica, constante atualização normativa e domínio de práticas administrativas, jurídicas e regulatórias em contínua evolução. A frequente alteração da legislação aplicável, especialmente no âmbito do Direito Administrativo, das contratações públicas e da regulação, aliada à crescente complexidade dos setores regulados e às exigências cada vez mais qualificadas dos órgãos de controle, impõe a necessidade permanente de aprimoramento das competências individuais e institucionais dos servidores. A inexistência de ações estruturadas de capacitação compromete a eficiência dos processos internos, amplia o risco de inconformidades, fragiliza a atuação regulatória e impacta negativamente a qualidade das decisões administrativas.

Nesse contexto, a participação de servidores em eventos, congressos e seminários técnicos, bem como a contratação de cursos e treinamentos especializados, presenciais ou a distância, constituem instrumentos essenciais para a atualização normativa e jurisprudencial, o intercâmbio de experiências, o acompanhamento de boas práticas regulatórias e o debate de temas emergentes. A capacitação contínua objetiva aprimorar o desempenho técnico e administrativo dos servidores, elevar a qualidade das análises e dos atos regulatórios, reduzir riscos jurídicos e institucionais, promover maior uniformidade de entendimentos e procedimentos, fortalecer a governança, a transparência e a eficiência da Agência, além de assegurar maior aderência às orientações dos órgãos de controle.`;

  const DEFAULT_CONSEQ_CAP = `A não realização de ações de capacitação pode resultar na desatualização técnica e normativa dos servidores, no aumento do risco de falhas procedimentais e de decisões inadequadas, bem como em maior vulnerabilidade a apontamentos dos órgãos de controle, comprometendo a qualidade da regulação e da fiscalização. Ademais, tal omissão tende a prejudicar o cumprimento das metas estratégicas institucionais e a impactar negativamente a imagem institucional da Agência.`;

  function autoResizeTextarea(ta){
    if(!ta) return;
    ta.style.height = "auto";
    ta.style.height = (ta.scrollHeight + 2) + "px";
  }

  function applyJustificativaCapacitacao(){
    const ta = justificativaNecessidadeEl;
    if(!ta) return;

    ta.classList.toggle("bigtext", __IS_CAP__);
    if(__IS_CAP__){
      if(!(ta.value || "").trim()){
        ta.value = DEFAULT_JUSTIFICATIVA_CAP;
      }
      autoResizeTextarea(ta);
      ta.addEventListener("input", ()=>autoResizeTextarea(ta));
    }else{
      ta.style.height = "";
    }
  }

  function applyConseqCapacitacao(){
    if(!__IS_CAP__) return;
    if(!consequenciaEl) return;
    if(!(consequenciaEl.value || "").trim()){
      consequenciaEl.value = DEFAULT_CONSEQ_CAP;
    }
    autoResizeTextarea(consequenciaEl);
    consequenciaEl.addEventListener("input", ()=>autoResizeTextarea(consequenciaEl));
  }

  function safeDiretoria(){
    const d = (dirDemSel?.value || "").trim();
    return d || "—";
  }
  function buildObjetoCap(d){ return `Capacitação de Servidores da ${d}`; }
  function buildItemDescEventos(d){ return `Participação de servidores da ${d} em eventos/congressos /seminários;`; }
  function buildItemDescCursos(d){ return `Cursos/treinamentos para os servidores da ${d}`; }

  let __OBJETO_DIRTY__ = false;
  function markObjetoDirtyOnce(){ __OBJETO_DIRTY__ = true; }

  function setObjetoDefaultIfAllowed(){
    if(!__IS_CAP__) return;
    if(__OBJETO_DIRTY__) return;
    if(!objetoEl) return;
    objetoEl.value = buildObjetoCap(safeDiretoria());
    autoResizeTextarea(objetoEl);
  }

  function isValidAno(ano){
    return /^[0-9]{4}$/.test(String(ano||"").trim());
  }

  function setPrazoCapFromAno(){
    if(!__IS_CAP__) return;
    const ano = (pcaAnoEl?.value || "").trim();
    prazosSel.innerHTML = "";
    if(!isValidAno(ano)){
      prazosSel.disabled = true;
      prazosGroup.classList.add('group-disabled');
      const o=document.createElement('option');
      o.value='';
      o.textContent='Informe o ano do PCA primeiro';
      prazosSel.appendChild(o);
      prazosSel.value = '';
      return;
    }

    const v = `dezembro de ${ano}`;
    prazosSel.disabled = true; // sempre fixo (cap)
    prazosGroup.classList.add('group-disabled');

    const o=document.createElement('option');
    o.value=v;
    o.textContent=v;
    prazosSel.appendChild(o);
    prazosSel.value = v;
  }

  // === Itens de capacitação (checklist) ===
  let capChkEventos = null;
  let capChkCursos = null;
  // preserva seleção quando re-renderiza (ex.: troca de diretoria)
  let capKeepEventos = false;
  let capKeepCursos = false;
  let __CAP_RENDER_KEY__ = '';

  function renderCapItemsSelector(){
    if(!capItemsBoxEl) return;
    capItemsBoxEl.innerHTML = "";
    if(!__IS_CAP__) return;

    const box = document.createElement('div');
    box.className = 'cap-box';

    const h = document.createElement('h3');
    h.textContent = 'Itens da capacitação';
    box.appendChild(h);

    const note = document.createElement('div');
    note.className = 'note';
    note.textContent = 'Selecione quais itens irão compor a DFD de capacitação (você pode marcar um ou os dois).';
    box.appendChild(note);

    const checks = document.createElement('div');
    checks.className = 'cap-checks';

    const mk = (id, title, subtitle)=>{
      const row = document.createElement('label');
      row.className = 'cap-check';
      row.setAttribute('for', id);

      const inp = document.createElement('input');
      inp.type = 'checkbox';
      inp.id = id;

      const text = document.createElement('div');
      text.className = 'txt';

      const t = document.createElement('div');
      t.textContent = title;

      const sub = document.createElement('div');
      sub.className = 'sub';
      sub.textContent = subtitle;

      text.appendChild(t);
      text.appendChild(sub);
      row.appendChild(inp);
      row.appendChild(text);
      return { row, inp };
    };

    const d = safeDiretoria();
    const a = mk('capItemEventos', 'Eventos / Congressos / Seminários', buildItemDescEventos(d));
    const b = mk('capItemCursos', 'Cursos / Treinamentos', buildItemDescCursos(d));

    a.inp.checked = capKeepEventos;
    b.inp.checked = capKeepCursos;

    capChkEventos = a.inp;
    capChkCursos = b.inp;

    checks.appendChild(a.row);
    checks.appendChild(b.row);
    box.appendChild(checks);

    const warn = document.createElement('div');
    warn.className = 'note';
    warn.id = 'capItemsWarn';
    warn.style.marginTop = '8px';
    warn.style.color = '#b91c1c';
    warn.textContent = '';
    box.appendChild(warn);

    capItemsBoxEl.appendChild(box);

    function onCapChange(){
      capKeepEventos = !!capChkEventos?.checked;
      capKeepCursos  = !!capChkCursos?.checked;
      ensureCapacitacaoItems();
      updateSubmitState();
    }

    capChkEventos.addEventListener('change', onCapChange);
    capChkCursos.addEventListener('change', onCapChange);

  }

  function capSelectedKinds(){
    const kinds = [];
    const ev = (capChkEventos ? capChkEventos.checked : capKeepEventos);
    const cu = (capChkCursos  ? capChkCursos.checked  : capKeepCursos);
    if(ev) kinds.push('eventos');
    if(cu) kinds.push('cursos');
    return kinds;
  }

  function capWarn(msg){
    const el = document.getElementById('capItemsWarn');
    if(el) el.textContent = msg || '';
  }

  async function loadConfig(){
    try{
      const r = await fetch('./config');
      if(!r.ok) throw new Error('config_http_'+r.status);
      const data = await r.json();
      __REAJUSTE_PCA_ATIVO__ = !!(data && data.reajustePcaAtivo);
      __CONFIG_LOADED__ = true;
      return true;
    }catch(e){
      __REAJUSTE_PCA_ATIVO__ = false;
      __CONFIG_LOADED__ = false;
      statusEl.textContent = 'Não foi possível carregar a configuração do período de reajuste do PCA. Recarregue a página.';
      return false;
    }
  }

  function helpIcon(text){
    const span=document.createElement('span');
    span.className='inline-help';
    const b=document.createElement('button');
    b.type='button';
    b.className='help';
    b.setAttribute('aria-label','Ajuda');
    b.textContent='?';
    const tip=document.createElement('span');
    tip.className='tip';
    tip.textContent=text;
    span.appendChild(b);
    span.appendChild(tip);
    return span;
  }

  function renderReajustePcaField(){
    if(!reajustePcaBox) return;
    reajustePcaBox.innerHTML = '';
    if(!__REAJUSTE_PCA_ATIVO__) return;

    const banner = document.createElement('div');
    banner.className = 'banner';
    banner.innerHTML = `<div aria-hidden="true">⚠️</div>
      <div><strong>Período de reajuste do PCA ativo.</strong> O campo abaixo é obrigatório para gerar o DFD.</div>`;

    const lbl = document.createElement('label');
    lbl.setAttribute('for', 'justificativaInclusaoItem');
    lbl.textContent = 'Justificativa para a inclusão do item';
    lbl.appendChild(helpIcon('Obrigatório durante o período de reajuste do PCA. Informe a justificativa para a inclusão desta DFD no período.'));

    const ta = document.createElement('textarea');
    ta.name = 'justificativaInclusaoItem';
    ta.id = 'justificativaInclusaoItem';
    ta.placeholder = 'Descreva a justificativa (uma por DFD).';
    ta.required = true;

    reajustePcaBox.appendChild(banner);
    reajustePcaBox.appendChild(lbl);
    reajustePcaBox.appendChild(ta);

    ensureRequiredStar(lbl, true);
  }

  async function loadModels(){
    try{
      const r=await fetch('./models');
      if(!r.ok) return;
      const data=await r.json();
      (data.items||[]).forEach(m=>{
        const o=document.createElement('option');
        o.value=m.slug;
        o.textContent=m.slug;
        modeloSel.appendChild(o);
      });
    }catch{}
  }

  function loadDiretoriasDemandantes(){
    LISTS.diretoriasDemandantes.forEach(v=>{
      const o=document.createElement('option');
      o.value=v;
      o.textContent=v;
      dirDemSel.appendChild(o);
    });
  }

  function loadGrauPrioridade(){
    const gpSel=document.getElementById('grauPrioridade');
    LISTS.grauPrioridade.forEach(v=>{
      const o=document.createElement('option');
      o.value=v;
      o.textContent=v;
      gpSel.appendChild(o);
    });
  }

  function mesesDoAno(ano){
    const n=["janeiro","fevereiro","março","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
    if(!/^[0-9]{4}$/.test(String(ano||""))) return [];
    return n.map(m=>`${m} de ${ano}`);
  }

  // Mantém o comportamento padrão (não-cap): select por mês/ano
  function rebuildPrazosOptions(){
    if(__IS_CAP__){
      setPrazoCapFromAno();
      return;
    }
    const ano=(pcaAnoEl?.value||'').trim();
    const valid=/^[0-9]{4}$/.test(ano);
    prazosSel.innerHTML='';
    if(!valid){
      prazosSel.disabled=true;
      prazosGroup.classList.add('group-disabled');
      const o=document.createElement('option');
      o.value='';
      o.textContent='Informe o ano do PCA primeiro';
      prazosSel.appendChild(o);
      return;
    }
    prazosSel.disabled=false;
    prazosGroup.classList.remove('group-disabled');
    const ph=document.createElement('option');
    ph.value='';
    ph.textContent='-- Selecionar --';
    prazosSel.appendChild(ph);
    mesesDoAno(ano).forEach(v=>{
      const o=document.createElement('option');
      o.value=v;
      o.textContent=v;
      prazosSel.appendChild(o);
    });
  }

  function smoothScrollTo(el){
    if(!el) return;
    const reduced=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    el.scrollIntoView({behavior: reduced?'auto':'smooth', block:'start'});
  }

  // ======= obrigatoriedade (asterisco) =======
  function ensureRequiredStar(labelEl, required=true){
    if(!labelEl) return;
    const existing = labelEl.querySelector(':scope > .req-star');
    if(!required){
      if(existing) existing.remove();
      return;
    }
    if(existing) return;

    const star=document.createElement('span');
    star.className='req-star';
    star.textContent='*';
    star.setAttribute('aria-hidden','true');

    const help = labelEl.querySelector(':scope > .inline-help');
    if(help) labelEl.insertBefore(star, help);
    else labelEl.appendChild(star);
  }

  function applyRequiredStars(root=document){
    if(!root || !root.querySelectorAll) return;
    root.querySelectorAll('label[for]').forEach(lbl=>{
      const forId = (lbl.getAttribute('for')||'').trim();
      if(!forId) return;

      if(forId === 'objetoUmItem') return;
      if(forId === 'pePilar' || forId === 'peObjetivo') return;
      if(forId.startsWith('capItem')) return;
      if(forId.includes('haDependencia')) return;
      if(forId.includes('dependenciaQual')) return;
      if(forId.includes('valorTotal')) return;

      ensureRequiredStar(lbl, true);
    });
  }
  // ==========================================

  // ======= Planejamento Estratégico =======
  let peSelected = [];
  let __PE_MSG_TIMER__ = null;

  function peSetMsg(msg){
    if(!peMsgEl) return;
    peMsgEl.textContent = msg || '';
    if(__PE_MSG_TIMER__) clearTimeout(__PE_MSG_TIMER__);
    if(msg){
      __PE_MSG_TIMER__ = setTimeout(()=>{ peMsgEl.textContent=''; }, 6000);
    }
  }

  function peBuildLine(pilarN, objetivoN, objetivoTxt){
    return `Está alinhado ao Planejamento Estratégico da Agepar 2026-2029 – Pilar ${pilarN} - Objetivo estratégico ${objetivoN}: ${objetivoTxt}`;
  }

  function peSyncTextarea(){
    if(!alinhamentoEl) return;
    alinhamentoEl.value = peSelected.map(x=>peBuildLine(x.pilarN, x.objetivoN, x.objetivoTxt)).join("\n");
  }

  function peRenderSelected(){
    if(!peSelectedEl) return;
    peSelectedEl.innerHTML = "";

    if(peSelected.length===0){
      const empty=document.createElement('div');
      empty.className='note';
      empty.style.marginTop='8px';
      empty.textContent='Nenhum objetivo selecionado ainda.';
      peSelectedEl.appendChild(empty);
      return;
    }

    peSelected.forEach((x, idx)=>{
      const row=document.createElement('div');
      row.className='pe-item';

      const left=document.createElement('div');
      left.className='txt';

      const meta=document.createElement('div');
      meta.className='meta';
      const tag=document.createElement('span');
      tag.className='tag';
      tag.textContent=`Pilar ${x.pilarN} • Obj ${x.objetivoN}`;
      meta.appendChild(tag);

      const txt=document.createElement('div');
      txt.style.marginTop='6px';
      txt.textContent = peBuildLine(x.pilarN, x.objetivoN, x.objetivoTxt);

      left.appendChild(meta);
      left.appendChild(txt);

      const rm=document.createElement('button');
      rm.type='button';
      rm.className='btn small danger rm';
      rm.textContent='Remover';
      rm.onclick=()=>{
        peSelected.splice(idx,1);
        peRenderSelected();
        peSyncTextarea();
        peSetMsg('');
        updateSubmitState();
      };

      row.appendChild(left);
      row.appendChild(rm);
      peSelectedEl.appendChild(row);
    });
  }

  function peLoadPilares(){
    if(!pePilarEl) return;
    if(pePilarEl.dataset.loaded === "1") return;
    PE_2026_2029.forEach(p=>{
      const o=document.createElement('option');
      o.value=String(p.n);
      o.textContent=p.label;
      pePilarEl.appendChild(o);
    });
    pePilarEl.dataset.loaded = "1";
  }

  function peLoadObjetivos(pilarN){
    if(!peObjetivoEl) return;
    peObjetivoEl.innerHTML = '<option value="">-- Selecionar --</option>';
    const p = PE_2026_2029.find(x=>x.n===pilarN);
    if(!p){
      peObjetivoEl.disabled=true;
      return;
    }
    p.objetivos.forEach((txt, i)=>{
      const o=document.createElement('option');
      o.value=String(i+1);
      o.textContent=`Objetivo ${i+1} — ${txt}`;
      peObjetivoEl.appendChild(o);
    });
    peObjetivoEl.disabled=false;
  }

  function peKey(pilarN, objetivoN){ return `${pilarN}-${objetivoN}`; }

  function peAddSelected(){
    const pilarN = parseInt(pePilarEl?.value || "", 10);
    const objetivoN = parseInt(peObjetivoEl?.value || "", 10);

    if(!pilarN){
      peSetMsg('Selecione um Pilar para continuar.');
      pePilarEl?.focus();
      return;
    }
    if(!objetivoN){
      peSetMsg('Selecione um Objetivo Estratégico para adicionar.');
      peObjetivoEl?.focus();
      return;
    }

    const p = PE_2026_2029.find(x=>x.n===pilarN);
    const objetivoTxt = p?.objetivos?.[objetivoN-1];
    if(!p || !objetivoTxt){
      peSetMsg('Objetivo inválido. Selecione novamente.');
      peObjetivoEl?.focus();
      return;
    }

    const k = peKey(pilarN, objetivoN);
    if(peSelected.some(x=>peKey(x.pilarN, x.objetivoN)===k)){
      peSetMsg('Esse Objetivo Estratégico já foi adicionado (não é permitido repetir).');
      peObjetivoEl?.focus();
      return;
    }

    peSelected.push({ pilarN, objetivoN, objetivoTxt });
    peSelected.sort((a,b)=> (a.pilarN-b.pilarN) || (a.objetivoN-b.objetivoN));

    peRenderSelected();
    peSyncTextarea();
    peSetMsg('');
    updateSubmitState();
  }
  // ==========================================

  function isSingleItemLocked(){
    if(__IS_CAP__) return false;
    return !!objetoUmItemEl?.checked;
  }

  function pruneItemsToSingle(){
    if(!isSingleItemLocked()) return false;
    let removed = false;
    while(itemsEl && itemsEl.children && itemsEl.children.length > 1){
      itemsEl.lastElementChild?.remove();
      removed = true;
    }
    return removed;
  }

  let itemSeq=0;
  function buildSelect(options, placeholder="-- Selecionar --"){
    const sel=document.createElement('select');
    const o0=document.createElement('option');
    o0.value='';
    o0.textContent=placeholder;
    sel.appendChild(o0);
    options.forEach(v=>{
      const o=document.createElement('option');
      o.value=v;
      o.textContent=v;
      sel.appendChild(o);
    });
    return sel;
  }

  function createHidden(name, value){
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = name;
    inp.value = value ?? "";
    return inp;
  }

  function createItem(preset){
    const idx=itemSeq++;
    const wrap=document.createElement('div');
    wrap.className='item';
    wrap.dataset.idx=idx;

    const meta=document.createElement('div');
    meta.className='meta';
    const title=document.createElement('div');
    title.innerHTML=`<span class="badge">Item</span> <strong class="item-number">#${idx+1}</strong>`;
    meta.appendChild(title);

    const lblDesc=document.createElement('label');
    lblDesc.textContent='Descrição sucinta do objeto';
    lblDesc.appendChild(helpIcon('Texto resumido do que será contratado/adquirido.'));
    const txtDesc=document.createElement('textarea');
    txtDesc.name=`items[${idx}][descricao]`;
    txtDesc.id=`item-${idx}-descricao`;
    txtDesc.required=true;
    lblDesc.htmlFor=txtDesc.id;

    if(preset && typeof preset.descricao === 'string') txtDesc.value = preset.descricao;
    if(preset && preset.lockDescricao){
      txtDesc.readOnly = true;
      txtDesc.classList.add('readonly');
      txtDesc.tabIndex = 0;
    }

    let row1 = null;
    let row2a = null;

    if(preset && preset.capDefaults){
      wrap.appendChild(createHidden(`items[${idx}][haDependencia]`, 'Não'));
      wrap.appendChild(createHidden(`items[${idx}][dependenciaQual]`, ''));
      wrap.appendChild(createHidden(`items[${idx}][renovacaoContrato]`, 'Não'));
    }else{
      row1=document.createElement('div');
      row1.className='row';

      const colDep=document.createElement('div');
      colDep.className='col';
      const lblDep=document.createElement('label');
      lblDep.textContent='Há vinculação ou dependência com a contratação de outro item?';
      lblDep.appendChild(helpIcon('Informe se este item possui vínculo/dependência com outra contratação.'));
      const selDep=buildSelect(LISTS.simNao);
      selDep.name=`items[${idx}][haDependencia]`;
      selDep.id=`item-${idx}-haDependencia`;
      lblDep.htmlFor=selDep.id;
      colDep.appendChild(lblDep);
      colDep.appendChild(selDep);

      const colRen=document.createElement('div');
      colRen.className='col';
      const lblRen=document.createElement('label');
      lblRen.textContent='Renovação de contrato';
      lblRen.appendChild(helpIcon('Indique se se trata de renovação de contrato.'));
      const selRen=buildSelect(LISTS.simNao);
      selRen.name=`items[${idx}][renovacaoContrato]`;
      selRen.id=`item-${idx}-renovacaoContrato`;
      selRen.required=true;
      lblRen.htmlFor=selRen.id;
      colRen.appendChild(lblRen);
      colRen.appendChild(selRen);

      row1.appendChild(colDep);
      row1.appendChild(colRen);

      row2a=document.createElement('div');
      row2a.className='row';
      const colQual=document.createElement('div');
      colQual.className='col group-disabled';
      colQual.id=`group-qual-${idx}`;
      const lblQual=document.createElement('label');
      lblQual.textContent="Se 'Sim', descreva o vínculo";
      lblQual.appendChild(helpIcon('Descreva a contratação vinculada/dependente.'));
      const inpQual=document.createElement('input');
      inpQual.placeholder='Ex.: Depende do contrato ABC';
      inpQual.name=`items[${idx}][dependenciaQual]`;
      inpQual.id=`item-${idx}-dependenciaQual`;
      inpQual.disabled=true;
      inpQual.required=false;
      lblQual.htmlFor=inpQual.id;
      colQual.appendChild(lblQual);
      colQual.appendChild(inpQual);
      row2a.appendChild(colQual);

      function toggleQual(){
        const show=(selDep.value==='Sim');
        inpQual.disabled=!show;
        inpQual.required=show;
        ensureRequiredStar(lblQual, show);
        colQual.classList.toggle('group-disabled', !show);
        if(!show) inpQual.value="";
      }
      selDep.addEventListener('change', toggleQual);
      toggleQual();
    }

    const row2=document.createElement('div');
    row2.className='row';

    const colQt=document.createElement('div');
    colQt.className='col';
    const lblQt=document.createElement('label');
    lblQt.textContent='Quantidade a ser adquirida';
    lblQt.appendChild(helpIcon('Informe um número inteiro.'));
    const inpQt=document.createElement('input');
    inpQt.type='number';
    inpQt.min='0';
    inpQt.step='1';
    inpQt.inputMode='numeric';
    inpQt.name=`items[${idx}][quantidade]`;
    inpQt.id=`item-${idx}-quantidade`;
    inpQt.required=true;
    lblQt.htmlFor=inpQt.id;
    colQt.appendChild(lblQt);
    colQt.appendChild(inpQt);

    const colUM=document.createElement('div');
    colUM.className='col';
    const lblUM=document.createElement('label');
    lblUM.textContent='Unidade de medida';
    lblUM.appendChild(helpIcon('Escolha uma unidade padronizada.'));
    const selUM=buildSelect(LISTS.unidadeMedida);
    selUM.name=`items[${idx}][unidadeMedida]`;
    selUM.id=`item-${idx}-unidadeMedida`;
    selUM.required=true;
    lblUM.htmlFor=selUM.id;
    colUM.appendChild(lblUM);
    colUM.appendChild(selUM);

    const colVU=document.createElement('div');
    colVU.className='col';
    const lblVU=document.createElement('label');
    lblVU.textContent='Estimativa de valor unitário (R$)';
    lblVU.appendChild(helpIcon('Use ponto como separador decimal.'));
    const inpVU=document.createElement('input');
    inpVU.type='number';
    inpVU.min='0';
    inpVU.step='0.01';
    inpVU.inputMode='decimal';
    inpVU.name=`items[${idx}][valorUnitario]`;
    inpVU.id=`item-${idx}-valorUnitario`;
    inpVU.required=true;
    lblVU.htmlFor=inpVU.id;
    colVU.appendChild(lblVU);
    colVU.appendChild(inpVU);

    const colVT=document.createElement('div');
    colVT.className='col group-disabled';
    const lblVT=document.createElement('label');
    lblVT.textContent='Estimativa de valor total (auto)';
    lblVT.appendChild(helpIcon('Calculado automaticamente: Quantidade × Valor unitário.'));
    const inpVT=document.createElement('input');
    inpVT.type='text';
    inpVT.readOnly=true;
    inpVT.disabled=true;
    inpVT.tabIndex=-1;
    inpVT.classList.add('readonly');
    inpVT.name=`items[${idx}][valorTotal]`;
    inpVT.id=`item-${idx}-valorTotal`;
    lblVT.htmlFor=inpVT.id;
    colVT.appendChild(lblVT);
    colVT.appendChild(inpVT);

    if(preset && preset.capDefaults){
      inpQt.value = "1";
      inpQt.disabled = true;

      selUM.value = "Unitário";
      if(selUM.value !== "Unitário"){
        const o=document.createElement('option');
        o.value="Unitário";
        o.textContent="Unitário";
        selUM.appendChild(o);
        selUM.value="Unitário";
      }
      selUM.disabled = true;

      // No modo capacitação, o valor unitário é derivado no backend (ou em outra etapa),
      // então não deve ser preenchido pelo usuário.
      inpVU.value = "0";
      inpVU.disabled = true;
      inpVU.required = false;
      inpVU.tabIndex = -1;
      inpVU.classList.add('readonly');
    }

    row2.appendChild(colQt);
    row2.appendChild(colUM);
    row2.appendChild(colVU);
    row2.appendChild(colVT);

    function recalc(){
      const q=parseFloat(inpQt.value||'0');
      const vu=parseFloat(inpVU.value||'0');
      const vt=(isFinite(q)&&isFinite(vu))?(q*vu):0;
      inpVT.value=(Math.round(vt*100)/100).toFixed(2);
    }
    inpQt.addEventListener('input', recalc);
    inpVU.addEventListener('input', recalc);
    recalc();

    wrap.appendChild(meta);
    wrap.appendChild(lblDesc); wrap.appendChild(txtDesc);
    if(row1) wrap.appendChild(row1);
    if(row2a) wrap.appendChild(row2a);
    wrap.appendChild(row2);

    if(!(preset && preset.hideActions)){
      const actions=document.createElement('div');
      actions.className='item-actions';
      const removeBtn=document.createElement('button');
      removeBtn.type='button';
      removeBtn.className='btn small danger remove-item';
      removeBtn.textContent='Remover';
      const addBtn=document.createElement('button');
      addBtn.type='button';
      addBtn.className='btn small secondary add-item';
      addBtn.textContent='Adicionar item';
      actions.appendChild(removeBtn);
      actions.appendChild(addBtn);

      removeBtn.onclick=()=>{
        if(itemsEl.children.length<=1){
          removeBtn.blur();
          wrap.style.animation='shake .2s';
          setTimeout(()=>wrap.style.animation='',250);
          return;
        }
        wrap.remove();
        recomputeItemNumbers();
        updateItemButtons();
      };

      addBtn.onclick=()=>{
        if (isSingleItemLocked()) return;
        itemsEl.appendChild(createItem());
        recomputeItemNumbers();
        updateItemButtons();
        const last=itemsEl.lastElementChild;
        if(last) last.querySelector('textarea, input, select')?.focus();
      };

      wrap.appendChild(actions);
    }

    applyRequiredStars(wrap);
    return wrap;
  }

  function updateItemButtons(){
    if(__IS_CAP__) return;
    const onlyOne=itemsEl.children.length<=1;
    const lock=isSingleItemLocked();
    Array.from(itemsEl.children).forEach((div,i,arr)=>{
      const isLast=i===arr.length-1;
      const removeBtn=div.querySelector('.remove-item');
      const addBtn=div.querySelector('.add-item');
      if(removeBtn) removeBtn.disabled=onlyOne;
      if(addBtn){
        addBtn.style.display=(isLast && !lock) ? '' : 'none';
        addBtn.disabled=lock;
        addBtn.title = lock ? 'Desabilitado: “apenas 1 item” está marcado.' : '';
      }
    });
  }

  function recomputeItemNumbers(){
    Array.from(itemsEl.children).forEach((div,i)=>{
      const numEl=div.querySelector('.item-number');
      if(numEl) numEl.textContent=`#${i+1}`;
      div.dataset.idx=String(i);

      div.querySelectorAll('[name^="items["]').forEach(el=>{
        el.name=el.name.replace(/items\[\d+\]/, `items[${i}]`);
      });
      div.querySelectorAll('[id^="item-"]').forEach(el=>{
        el.id=el.id.replace(/item-\d+-/, `item-${i}-`);
      });
      div.querySelectorAll('label[for^="item-"]').forEach(l=>{
        l.htmlFor=l.htmlFor.replace(/item-\d+-/, `item-${i}-`);
      });
    });
  }

  function ensureCapacitacaoItems(){
    if(!__IS_CAP__ || !itemsEl) return;

    const d = safeDiretoria();
    const kinds = capSelectedKinds();

    capWarn(kinds.length === 0 ? 'Selecione ao menos um item (Eventos e/ou Cursos).' : '');

    // chave = diretoria + seleção (porque as descrições mudam com a diretoria)
    const key = `${d}::${kinds.join(',')}`;
    if(key === __CAP_RENDER_KEY__ && itemsEl.children.length > 0){
      return; // nada mudou, não re-renderiza
    }
    __CAP_RENDER_KEY__ = key;

    if(objetoUmItemBoxEl) objetoUmItemBoxEl.style.display = 'none';

    itemsEl.innerHTML = '';
    itemSeq = 0;

    const presetBase = { capDefaults:true, lockDescricao:true, hideActions:true };

    if(kinds.includes('eventos')){
      itemsEl.appendChild(createItem({ ...presetBase, descricao: buildItemDescEventos(d) }));
    }
    if(kinds.includes('cursos')){
      itemsEl.appendChild(createItem({ ...presetBase, descricao: buildItemDescCursos(d) }));
    }

    recomputeItemNumbers();
  }


  function ensureOneItem(){
    if(__IS_CAP__){ ensureCapacitacaoItems(); return; }

    let changed = false;
    if(itemsEl.children.length===0){
      itemsEl.appendChild(createItem());
      changed = true;
    }
    if (pruneItemsToSingle()) changed = true;
    if (changed) recomputeItemNumbers();
    updateItemButtons();
  }

  pcaAnoEl?.addEventListener('input', rebuildPrazosOptions);

  function syncObjToFirstItem(){
    if(__IS_CAP__) return;
    const first=itemsEl.firstElementChild;
    if(!first) return;
    const desc=first.querySelector('textarea[name$="[descricao]"]');
    if(desc) desc.value=objetoEl.value||"";
  }

  objetoUmItemEl?.addEventListener('change', ()=>{
    ensureOneItem();
    if(objetoUmItemEl.checked) syncObjToFirstItem();
    updateItemButtons();
  });

  objetoEl?.addEventListener('input', ()=>{
    markObjetoDirtyOnce();
    autoResizeTextarea(objetoEl);
    if(objetoUmItemEl.checked) syncObjToFirstItem();
  });

  dirDemSel?.addEventListener('change', ()=>{
    if(__IS_CAP__){
      setObjetoDefaultIfAllowed();
      renderCapItemsSelector();
      ensureCapacitacaoItems(); // key já muda com a diretoria; force é desnecessário
      updateSubmitState();
    }
  });

  function updateSubmitState(){
    const hasProto = (protocoloEl?.value || '').trim().length > 0;
    const hasPE = (alinhamentoEl?.value || '').trim().length > 0;
    const hasCapItem = !__IS_CAP__ || capSelectedKinds().length > 0;
    const enabled = __CONFIG_LOADED__ && hasProto && hasPE && hasCapItem;

    submitBtn.disabled = !enabled;
    submitBtn.setAttribute('aria-disabled', String(!enabled));

    if(enabled){ submitBtn.title = ''; return; }
    if(!__CONFIG_LOADED__){ submitBtn.title = 'Carregando configuração do período...'; return; }
    if(__IS_CAP__ && !hasCapItem){ submitBtn.title = 'Selecione ao menos 1 item de capacitação (Eventos e/ou Cursos).'; return; }
    if(!hasProto && !hasPE){ submitBtn.title = 'Informe o Protocolo e selecione ao menos 1 objetivo estratégico.'; return; }
    if(!hasProto){ submitBtn.title = 'Informe o Protocolo para gerar o DFD.'; return; }
    if(!hasPE){ submitBtn.title = 'Selecione ao menos 1 objetivo estratégico para gerar o DFD.'; return; }
  }

  protocoloEl?.addEventListener('input', updateSubmitState);

  function getFieldValue(div, selector){
    const el = div.querySelector(selector);
    if(!el) return "";
    return (el.value ?? "").toString();
  }

  function formToPayload(){
    const header={
      modeloSlug:f.modeloSlug.value||"",
      numero:f.numero.value||"",
      assunto:f.assunto.value||"",
      pcaAno:f.pcaAno.value||"",
      diretoriaDemandante:f.diretoriaDemandante.value||"",
      alinhamentoPE:(alinhamentoEl?.value || ""),
      justificativaNecessidade:f.justificativaNecessidade.value||"",
      objeto:f.objeto.value||"",
      prazosEnvolvidos:f.prazosEnvolvidos.value||"",
      consequenciaNaoAquisicao:f.consequenciaNaoAquisicao.value||"",
      grauPrioridade:f.grauPrioridade.value||"",
      protocolo:f.protocolo.value||""
    };

    if(__REAJUSTE_PCA_ATIVO__){
      const j = document.getElementById('justificativaInclusaoItem');
      header.justificativaInclusaoItem = (j?.value || "");
    }

    const children = Array.from(itemsEl.children);
    const itemNodes = isSingleItemLocked() ? children.slice(0,1) : children;

    const items = itemNodes.map(div=>{
      const num = (x)=>{
        const v=parseFloat(x||'0');
        return isFinite(v)?v:0;
      };

      const dep = getFieldValue(div, 'select[name$="[haDependencia]"], input[type="hidden"][name$="[haDependencia]"]');
      const ren = getFieldValue(div, 'select[name$="[renovacaoContrato]"], input[type="hidden"][name$="[renovacaoContrato]"]');

      const depQualRaw = getFieldValue(div, 'input[name$="[dependenciaQual]"], input[type="hidden"][name$="[dependenciaQual]"]');
      const depQual = (dep === 'Sim') ? depQualRaw : "";

      return {
        descricao: getFieldValue(div, 'textarea[name$="[descricao]"]'),
        haDependencia: dep || "",
        dependenciaQual: depQual || "",
        renovacaoContrato: ren || "",
        quantidade: Math.trunc(num(getFieldValue(div, 'input[name$="[quantidade]"]'))),
        unidadeMedida: getFieldValue(div, 'select[name$="[unidadeMedida]"]'),
        valorUnitario: num(getFieldValue(div, 'input[name$="[valorUnitario]"]')),
        valorTotal: num(getFieldValue(div, 'input[name$="[valorTotal]"]'))
      };
    });

    return { ...header, items };
  }

  async function submit(evt){
    evt.preventDefault();
    submitBtn.disabled=true;
    statusEl.textContent='Enviando...';
    smoothScrollTo(subsEl);

    ensureOneItem();

    if(__IS_CAP__){
      const kinds = capSelectedKinds();
      if(kinds.length === 0){
        statusEl.textContent='Erro: selecione ao menos um item de capacitação (Eventos e/ou Cursos).';
        smoothScrollTo(capItemsBoxEl);
        updateSubmitState();
        return;
      }
      // prazo fixo deve estar preenchido quando o ano estiver válido
      if(!f.prazosEnvolvidos.value){
        statusEl.textContent='Erro: informe um ano válido do PCA para preencher o prazo (“dezembro de AAAA”).';
        smoothScrollTo(pcaAnoEl);
        updateSubmitState();
        return;
      }
    }

    const payload=formToPayload();

    const peTxt = (payload.alinhamentoPE || '').trim();
    if(!peTxt){
      statusEl.textContent='Erro: selecione ao menos 1 Objetivo Estratégico para o alinhamento com o Planejamento Estratégico.';
      smoothScrollTo(statusEl);
      updateSubmitState();
      return;
    }
    if(__REAJUSTE_PCA_ATIVO__){
      const txt = (payload.justificativaInclusaoItem || '').trim();
      if(!txt){
        statusEl.textContent='Erro: Justificativa para a inclusão do item é obrigatória durante o período de reajuste do PCA.';
        smoothScrollTo(statusEl);
        updateSubmitState();
        return;
      }
    }

    let res, data;
    try{
      res=await fetch('./submit',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      try{ data=await res.json(); }catch{ data={}; }
    }
    catch(e){
      statusEl.textContent='Erro de rede ao enviar. Tente novamente.';
      updateSubmitState();
      return;
    }

    if(!res.ok){
      let msg=(data&&data.message)?data.message:`HTTP ${res.status}`;
      const details=(data&&data.details&&data.details.errors);
      if(Array.isArray(details)&&details.length){ msg+=' — '+details.join(' | '); }
      statusEl.textContent='Erro: '+msg;
      smoothScrollTo(statusEl);
      updateSubmitState();
      return;
    }

    statusEl.textContent='Fila criada, aguardando processamento...';
    const sid=data.submissionId;
    let tries=0;
    let row=null;

    while(tries<120){
      await new Promise(r=>setTimeout(r,1000));
      try{
        const r=await fetch('./submissions/'+sid);
        row=await r.json();
      }catch{}
      if(row&&(row.status==='done'||row.status==='error')) break;
      tries++;
    }

    if(!row){
      statusEl.textContent='Falha ao acompanhar processamento.';
      updateSubmitState();
      return;
    }

    if(row.status==='done'){
      statusEl.textContent='Pronto! Download do arquivo abaixo.';
      const div=document.createElement('div');
      div.className='item';

      const toObj=x=>{
        if(!x) return {};
        if(typeof x==='string'){ try{ return JSON.parse(x);}catch{return{};} }
        if(typeof x==='object') return x;
        return {};
      };

      const d=toObj(row.result);
      const displayName=(()=>{
        const n=(d.filename||d.filename_pdf||d.filename_docx||'').trim();
        const i=n.lastIndexOf('.');
        return i>0?n.slice(0,i):n;
      })();

      const meta=document.createElement('div');
      meta.className='meta';
      const badge=document.createElement('span');
      badge.className='badge';
      badge.textContent='done';
      const when=new Date(d.generated_at||Date.now()).toLocaleString();
      const title=document.createElement('span');
      title.textContent=` ${displayName} — ${when}`;
      meta.appendChild(badge);
      meta.appendChild(title);

      const buttons=document.createElement('div');
      buttons.className='btn-row';

      if(d.filename_pdf && d.file_path_pdf){
        const btnPdf=document.createElement('button');
        btnPdf.type='button';
        btnPdf.className='btn';
        btnPdf.textContent='Baixar PDF';
        btnPdf.onclick=async()=>{
          try{
            const dl=await fetch('./submissions/'+sid+'/download/pdf',{method:'POST'});
            if(!dl.ok) throw new Error();
            const blob=await dl.blob();
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=(d.filename_pdf||('dfd_'+sid+'.pdf'));
            a.click();
            URL.revokeObjectURL(a.href);
          }catch(e){
            alert('Não foi possível baixar o PDF.');
          }
        };
        buttons.appendChild(btnPdf);
      }

      const btnDocx=document.createElement('button');
      btnDocx.type='button';
      btnDocx.className='btn secondary';
      btnDocx.textContent='Baixar DOCX';
      btnDocx.onclick=async()=>{
        try{
          const dl=await fetch('./submissions/'+sid+'/download/docx',{method:'POST'});
          if(!dl.ok) throw new Error();
          const blob=await dl.blob();
          const a=document.createElement('a');
          a.href=URL.createObjectURL(blob);
          a.download=(d.filename_docx||('dfd_'+sid+'.docx'));
          a.click();
          URL.revokeObjectURL(a.href);
        }catch(e){
          alert('Não foi possível baixar o DOCX.');
        }
      };
      buttons.appendChild(btnDocx);

      div.appendChild(meta);
      div.appendChild(buttons);
      subsEl.prepend(div);
      smoothScrollTo(div);
      const firstBtn=div.querySelector('button');
      if(firstBtn) firstBtn.focus();
    } else {
      statusEl.textContent='Erro ao gerar: '+(row.error||'desconhecido');
      smoothScrollTo(statusEl);
    }

    updateSubmitState();
  }

  async function init(){
    loadModels();
    loadDiretoriasDemandantes();
    loadGrauPrioridade();

    peLoadPilares();
    peRenderSelected();
    peSyncTextarea();
    pePilarEl?.addEventListener('change', ()=>{
      peSetMsg('');
      const pN=parseInt(pePilarEl.value||'',10);
      peLoadObjetivos(isFinite(pN)?pN:0);
    });

    peAddBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      peAddSelected();
    });

    statusEl.textContent = 'Carregando configuração...';
    const ok = await loadConfig();
    if(ok){
      renderReajustePcaField();
      statusEl.textContent = '';
    }

    applyJustificativaCapacitacao();

    applyPrazosTip();
    rebuildPrazosOptions();

    if(__IS_CAP__){
      setObjetoDefaultIfAllowed();
      renderCapItemsSelector();
      ensureCapacitacaoItems();
      applyConseqCapacitacao();
      if(objetoUmItemBoxEl) objetoUmItemBoxEl.style.display = 'none';
      // No modo capacitação, o usuário não preenche a seção "Itens"
      // (o valor unitário será derivado das tabelas de eventos/cursos).
      itemsTitleEl?.classList.add('hidden');
      itemsNoteEl?.classList.add('hidden');
      itemsEl?.classList.add('hidden');
    }else{
      ensureOneItem();
    }

    applyRequiredStars(document);
    updateSubmitState();
  }

  f.addEventListener('submit', submit);
  init();
</script>
</body>
</html>