<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Histórico — Meus DFDs</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --pri:#2563eb; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Noto Color Emoji',sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0; }
  .card { background:var(--card); border:1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding: 16px; }
  .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 12px 0 14px; }
  .toolbar input, .toolbar select { padding: 10px 12px; border:1px solid #cbd5e1; border-radius: 10px; font: inherit; background:#fff; }
  .btn { background: var(--pri); color:#fff; border:1px solid transparent; border-radius: 10px; padding: 10px 16px; cursor:pointer; transition:.16s ease; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.ghost { background:transparent; color:#334155; border:1px solid #cbd5e1; }
  .btn.small { padding:8px 12px; font-size:12px; }
  .btn[disabled] { opacity:.6; cursor:not-allowed; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
  .btn-row .btn { white-space: nowrap; }

  /* Tabela com layout fixo e quebra de linha para evitar "empurrar" as ações */
  table { width:100%; border-collapse: collapse; table-layout: fixed; }
  th, td { text-align:left; padding:10px 12px; border-bottom:1px solid #e2e8f0; vertical-align: top; }
  th { font-size:12px; color:#475569; text-transform: uppercase; letter-spacing:.02em; }

  /* Quebras agressivas para textos longos (sem espaços) */
  td, .cell-assunto, .cell-assunto div, .subline {
    overflow-wrap:anywhere;          /* quebra até palavras longas */
    word-break:break-word;           /* compatibilidade */
    white-space:normal;              /* permite múltiplas linhas */
  }

  .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius: 999px; background:#eef2ff; color:#1e3a8a; }
  .badge.err { background:#fee2e2; color:#991b1b; }
  .badge.warn{ background:#fef3c7; color:#92400e; }
  .muted { color:#64748b; }
  .subline { color:#64748b; font-size:12px; margin-top:4px; }
</style>
</head>
<body>

<div class="wrap">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h1>Histórico — Meus DFDs</h1>
    <a href="../ui" class="btn secondary small">← Voltar ao formulário</a>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="toolbar">
      <input id="q" placeholder="Buscar por nº do memorando, objeto, assunto, diretoria, ano PCA…" style="flex:1; min-width:260px;" />
      <select id="sort">
        <option value="date_desc">Mais recentes</option>
        <option value="date_asc">Mais antigos</option>
        <option value="numero_asc">Número (A→Z)</option>
        <option value="numero_desc">Número (Z→A)</option>
      </select>
      <button id="refresh" class="btn ghost">Recarregar</button>
      <button id="more" class="btn secondary">Carregar mais</button>
    </div>

    <div style="overflow:auto;">
      <table id="tbl">
        <colgroup>
          <col style="width:160px">
          <col style="width:160px">
          <col> <!-- Assunto ocupa o restante, quebra em múltiplas linhas -->
          <col style="width:120px">
          <col style="width:220px">
        </colgroup>
        <thead>
          <tr>
            <th>Data</th>
            <th>Nº Memorando</th>
            <th>Assunto</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="empty" class="muted" style="display:none; padding:8px 0;">Nenhuma submissão encontrada.</div>
  </div>
</div>

<script>
  const tbody = document.getElementById('tbody');
  const emptyEl = document.getElementById('empty');
  const q = document.getElementById('q');
  const sortSel = document.getElementById('sort');
  const btnMore = document.getElementById('more');
  const btnRefresh = document.getElementById('refresh');

  let items = [];     // acumulado do servidor
  let filtered = [];  // filtrado + ordenado
  let offset = 0;
  const limit = 20;
  let loading = false;
  let end = false;    // recebeu menos que limit

  function parseJSON(x, fallback = {}) {
    if (!x) return fallback;
    if (typeof x === 'string') {
      try { return JSON.parse(x); } catch { return fallback; }
    }
    if (typeof x === 'object') return x;
    return fallback;
  }
  function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function payloadOf(row){ return parseJSON(row.payload || "{}", {}); }
  function resultOf(row){ return parseJSON(row.result || "{}", {}); }

  function buildAssuntoFrom(row) {
    const res = resultOf(row);
    if (res && res.assunto) return res.assunto;
    const p = payloadOf(row);
    const assunto = p.assunto || "";
    const ano = p.pcaAno || p.pca_ano || "";
    return (assunto && ano) ? (`DFD - PCA ${ano} - ${assunto}`) : (assunto || "");
  }
  function buildObjetoFrom(row) {
    const p = payloadOf(row);
    return p.objeto || "";
  }
  function buildDiretoriaFrom(row) {
    const p = payloadOf(row);
    return p.diretoriaDemandante || p.diretoria_demandante || "";
  }
  function rowPcaAno(row){
    const p = payloadOf(row);
    return p.pcaAno || p.pca_ano || "";
  }
  function rowDate(row) {
    const res = resultOf(row);
    const when = res.generated_at || row.updated_at || row.created_at;
    return when ? new Date(when) : new Date();
  }
  function rowNumero(row) {
    const p = payloadOf(row);
    return p.numero || "";
  }

  function renderTable() {
    tbody.innerHTML = "";
    if (filtered.length === 0) {
      emptyEl.style.display = "";
      return;
    }
    emptyEl.style.display = "none";

    for (const row of filtered) {
      const tr = document.createElement("tr");

      // Data
      const tdDate = document.createElement("td");
      tdDate.textContent = rowDate(row).toLocaleString();
      tr.appendChild(tdDate);

      // Número
      const tdNum = document.createElement("td");
      tdNum.textContent = rowNumero(row);
      tr.appendChild(tdNum);

      // Assunto + sublinha (objeto / diretoria)
      const tdAss = document.createElement("td");
      tdAss.className = "cell-assunto";
      const assuntoFinal = buildAssuntoFrom(row);
      const objeto = buildObjetoFrom(row);
      const dir = buildDiretoriaFrom(row);
      tdAss.innerHTML = `<div>${escapeHTML(assuntoFinal)}</div>` +
                        ((objeto || dir) ? `<div class="subline">${escapeHTML(objeto)}${dir ? ' — ' + escapeHTML(dir) : ''}</div>` : '');
      tr.appendChild(tdAss);

      // Status
      const tdSt = document.createElement("td");
      const st = row.status || "queued";
      const badge = document.createElement("span");
      badge.className = "badge" + (st === "error" ? " err" : (st !== "done" ? " warn" : ""));
      badge.textContent = st;
      tdSt.appendChild(badge);
      tr.appendChild(tdSt);

      // Ações
      const tdAct = document.createElement("td");
      const btns = document.createElement("div");
      btns.className = "btn-row";

      if (st === "done") {
        const d = resultOf(row);
        if (d.filename_pdf && d.file_path_pdf) {
          const bPdf = document.createElement("button");
          bPdf.type = "button";
          bPdf.className = "btn small";
          bPdf.textContent = "PDF";
          bPdf.onclick = async () => {
            const r = await fetch('../submissions/' + row.id + '/download/pdf', { method: 'POST' });
            if (!r.ok) return alert('Falha no download (PDF).');
            const blob = await r.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = d.filename_pdf || ('dfd_' + row.id + '.pdf');
            a.click();
            URL.revokeObjectURL(a.href);
          };
          btns.appendChild(bPdf);
        }
        const bDocx = document.createElement("button");
        bDocx.type = "button";
        bDocx.className = "btn secondary small";
        bDocx.textContent = "DOCX";
        bDocx.onclick = async () => {
          const r = await fetch('../submissions/' + row.id + '/download/docx', { method: 'POST' });
          if (!r.ok) return alert('Falha no download (DOCX).');
          const blob = await r.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (d.filename_docx || ('dfd_' + row.id + '.docx'));
          a.click();
          URL.revokeObjectURL(a.href);
        };
        btns.appendChild(bDocx);
      } else {
        const span = document.createElement("span");
        span.className = "muted";
        span.textContent = "Processando…";
        btns.appendChild(span);
      }

      tdAct.appendChild(btns);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    }
  }

  function applyFilterAndSort() {
    const term = (q.value || "").trim().toLowerCase();
    const sorter = sortSel.value;

    filtered = items.filter(row => {
      const num = rowNumero(row).toLowerCase();
      const ass = buildAssuntoFrom(row).toLowerCase();
      const obj = buildObjetoFrom(row).toLowerCase();
      const dir = buildDiretoriaFrom(row).toLowerCase();
      const ano = String(rowPcaAno(row) || "").toLowerCase();
      return !term || num.includes(term) || ass.includes(term) || obj.includes(term) || dir.includes(term) || ano.includes(term);
    });

    filtered.sort((a, b) => {
      if (sorter === "date_desc" || sorter === "date_asc") {
        const da = rowDate(a).getTime();
        const db = rowDate(b).getTime();
        return sorter === "date_desc" ? (db - da) : (da - db);
      }
      const na = rowNumero(a);
      const nb = rowNumero(b);
      return sorter === "numero_desc"
        ? nb.localeCompare(na, 'pt-BR', { numeric: true, sensitivity: 'base' })
        : na.localeCompare(nb, 'pt-BR', { numeric: true, sensitivity: 'base' });
    });

    renderTable();
  }

  async function fetchPage({ reset=false } = {}) {
    if (loading || end) return;
    loading = true;
    try {
      if (reset) {
        items = [];
        offset = 0;
        end = false;
      }
      const r = await fetch(`../submissions?limit=${limit}&offset=${offset}`);
      if (!r.ok) return;
      const data = await r.json();
      const rows = (data && data.items) || [];
      items = items.concat(rows);
      offset += rows.length;
      if (rows.length < limit) end = true;
      applyFilterAndSort();
      btnMore.disabled = end;
      btnMore.textContent = end ? "Fim da lista" : "Carregar mais";
    } finally {
      loading = false;
    }
  }

  // eventos
  btnMore.addEventListener('click', (e) => { e.preventDefault(); fetchPage(); });
  btnRefresh.addEventListener('click', (e) => { e.preventDefault(); fetchPage({ reset:true }); });
  q.addEventListener('input', () => { applyFilterAndSort(); });
  sortSel.addEventListener('change', () => { applyFilterAndSort(); });

  // init
  fetchPage({ reset:true });
</script>

</body>
</html>
