<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fileshare — Uploader temporário</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#fff; --pri:#2563eb; }
  * { box-sizing:border-box }
  html,body { margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; }

  /* Bloco de cima: largura padrão */
  .wrap { max-width: 960px; margin: 20px auto; padding: 0 16px; }

  /* Bloco de baixo: largura dinâmica, centralizado */
  .wide {
    max-width: min(1280px, calc(100vw - 32px));
    margin: 14px auto 20px;
    padding: 0 16px;
  }

  .card { background:var(--card); border:1px solid #e2e8f0; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  h1 { font-size:18px; margin:0 0 10px }
  label { display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
  input, select { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; font:inherit; background:#fff; }

  .row { display:flex; gap:12px; }
  .row > * { flex:1; }

  .btn { background:var(--pri); color:#fff; border:1px solid transparent; border-radius:10px; padding:10px 14px; cursor:pointer; flex:0 0 auto; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn[disabled] { opacity:.55; cursor:not-allowed; }

  .btn-row { display:flex; gap:8px; align-items:center; }
  .btn-row.right { justify-content:flex-end; }

  /* Toolbar inferior (status à esquerda; botões à direita) */
  .toolbar { display:flex; align-items:center; gap:8px; margin-top:10px; }
  .toolbar .spacer { flex:1; }

  /* Dropzone */
  .dropzone {
    border:2px dashed #94a3b8;
    background:#f8fafc;
    border-radius:12px;
    padding:22px;
    text-align:center;
    color:#475569;
    cursor:pointer;
    transition:border-color .15s ease, background .15s ease;
  }
  .dropzone:hover { background:#f1f5f9; }
  .dropzone.dragover { border-color:#2563eb; background:#eff6ff; }
  .dropzone .title { font-weight:600; color:#0f172a; }
  .dropzone .hint { font-size:12px; color:#64748b; margin-top:6px; }
  .file-info { margin-top:8px; font-size:12px; color:#475569; }

  table { width:100%; border-collapse:collapse; margin-top:12px; background:#fff; }
  th, td { padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; }
  th { font-size:12px; color:#64748b; background:#f8fafc; }
  .nowrap { white-space:nowrap }
  .muted { color:#64748b; font-size:12px; }

  /* Coluna AÇÕES */
  th:nth-child(5), td:nth-child(5) { text-align:center; width:280px; }

  /* Badges */
  .badge {
    display:inline-block; font-size:11px; line-height:1; padding:4px 6px;
    border-radius:999px; border:1px solid #cbd5e1; background:#f1f5f9; color:#334155; margin-left:6px;
    vertical-align:middle;
  }
  .badge.lock { border-color:#94a3b8; background:#e2e8f0; }

  /* Tabela com rolagem horizontal em telas estreitas */
  .table-wrap { overflow-x:auto; }

  /* Responsividade */
  @media (max-width: 800px){
    .row { flex-direction:column; }
  }
  @media (max-width: 600px){
    th:nth-child(5), td:nth-child(5) { width:auto; }
    .btn-row.right { justify-content:flex-end; }
    .toolbar { gap:6px; }
  }
</style>
</head>
<body>

<!-- BLOCO DE CIMA -->
<div class="wrap">
  <h1>Uploader temporário (Fileshare)</h1>

  <div class="card">
    <form id="frm" enctype="multipart/form-data" novalidate>
      <label>Arquivo</label>
      <!-- input real fica oculto; a interação acontece pela dropzone -->
      <input id="fileInput" type="file" name="file" required style="display:none" />
      <!-- opcional: restrição de tipos (se desejar, descomente e ajuste no backend: ALLOWED_MIME_PREFIXES)
           <input id="fileInput" type="file" name="file" accept="image/*,application/pdf" required style="display:none" />
      -->
      <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Área para arrastar ou clicar para selecionar arquivo">
        <div class="title">Arraste e solte o arquivo aqui</div>
        <div class="hint">ou clique para selecionar no seu computador</div>
        <div id="fileInfo" class="file-info" style="display:none"></div>
      </div>

      <div class="row">
        <div>
          <label>Tempo de vida</label>
          <select name="ttl">
            <option value="1d">1 dia</option>
            <option value="7d" selected>1 semana</option>
            <option value="30d">1 mês</option>
          </select>
        </div>
        <div>
          <label>Chave secreta (opcional)</label>
          <input name="secret" placeholder="Senha para baixar" />
        </div>
      </div>

      <!-- Somente o ENVIAR aqui, à direita -->
      <div class="btn-row right" style="margin-top:10px">
        <button class="btn" id="btnSend" type="submit">Enviar</button>
      </div>
    </form>
  </div>
</div>

<!-- BLOCO DE BAIXO -->
<div class="wide">
  <div class="card">
    <div class="row">
      <div>
        <label>Mostrar</label>
        <select id="owner">
          <option value="all" selected>Todos</option>
          <option value="me">Meus</option>
        </select>
      </div>
      <div>
        <label>Busca</label>
        <input id="q" placeholder="nome do arquivo..." />
      </div>
    </div>

    <!-- Toolbar inferior: status à esquerda; à direita: Atualizar lista e Filtrar -->
    <div class="toolbar">
      <span class="muted" id="status" aria-live="polite"></span>
      <div class="spacer"></div>
      <button class="btn secondary" id="btnRefresh" type="button">Atualizar lista</button>
      <button class="btn" id="btnApply" type="button">Filtrar</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ARQUIVO</th>
            <th class="nowrap">TAMANHO</th>
            <th class="nowrap">EXPIRA</th>
            <th class="nowrap">DONO</th>
            <th class="nowrap">AÇÕES</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const $ = sel => document.querySelector(sel);
  const fmtSize = n => !n && n!==0 ? "—" : (n<1024? `${n} B` : n<1024**2? `${(n/1024).toFixed(1)} KB` : `${(n/1024**2).toFixed(1)} MB`);
  const fmtDate = s => new Date(s).toLocaleString();

  let currentUserId = null;
  let isSuperuser = false;

  async function getMe(){
    try{
      const r = await fetch("/api/me", { credentials:"include" });
      if(!r.ok) return;
      const me = await r.json();
      currentUserId = me?.cpf || null;
      isSuperuser = !!me?.is_superuser;
    }catch(_){}
  }

  // ---------- Dropzone ----------
  function setupDropzone(){
    const dz = $("#dropzone");
    const fi = $("#fileInput");
    const info = $("#fileInfo");

    function showFileInfo(file){
      if(!file){ info.style.display="none"; info.textContent=""; return; }
      info.style.display="block";
      info.textContent = `Selecionado: ${file.name} (${fmtSize(file.size)})`;
    }

    dz.addEventListener("click", () => fi.click());
    dz.addEventListener("keydown", (ev) => {
      if(ev.key === "Enter" || ev.key === " "){ ev.preventDefault(); fi.click(); }
    });

    ["dragenter","dragover"].forEach(evt => {
      dz.addEventListener(evt, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); dz.classList.add("dragover"); });
    });
    ["dragleave","drop"].forEach(evt => {
      dz.addEventListener(evt, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); dz.classList.remove("dragover"); });
    });
    dz.addEventListener("drop", (ev)=>{
      const files = ev.dataTransfer?.files;
      if(!files || files.length===0) return;
      if(files.length>1){ alert("Selecione apenas um arquivo por envio."); return; }
      const dt = new DataTransfer();
      dt.items.add(files[0]);
      fi.files = dt.files;
      showFileInfo(files[0]);
    });

    fi.addEventListener("change", ()=> showFileInfo(fi.files?.[0]));
  }

  // ---------- Upload ----------
  async function upload(ev){
    ev.preventDefault();

    const fi = $("#fileInput");
    const btn = $("#btnSend");
    if(!fi.files || fi.files.length === 0){
      alert("Selecione um arquivo para enviar.");
      return;
    }

    const fd = new FormData(ev.target);

    btn.disabled = true;
    btn.textContent = "Enviando...";

    let r;
    try{
      r = await fetch("/api/automations/fileshare/submit", {
        method:"POST",
        body: fd,
        credentials:"include"
      });
    }catch(e){
      alert("Falha de rede ao enviar o arquivo.");
      btn.disabled = false;
      btn.textContent = "Enviar";
      return;
    }

    if(!r.ok){
      let msg = "";
      try { msg = await r.text(); } catch(_){}
      if(r.status === 413){
        alert("Arquivo excede o limite configurado no servidor.");
      }else if(r.status === 415){
        alert("Tipo de arquivo não permitido pela política do servidor.");
      }else{
        alert(`Falha no upload (${r.status}). ${msg||""}`.trim());
      }
      btn.disabled = false;
      btn.textContent = "Enviar";
      return;
    }

    await load();
    ev.target.reset();
    const info = $("#fileInfo");
    if(info){ info.textContent=""; info.style.display="none"; }
    btn.disabled = false;
    btn.textContent = "Enviar";
  }

  // ---------- Listagem ----------
  async function load(){
    const owner = $("#owner").value;
    const q = $("#q").value.trim();
    const url = `/api/automations/fileshare/items?owner=${encodeURIComponent(owner)}&limit=100${q?`&q=${encodeURIComponent(q)}`:""}`;
    $("#status").textContent = "Carregando...";
    try{
      const r = await fetch(url, { credentials:"include" });
      if(!r.ok){
        $("#status").textContent = `Erro ${r.status} ao carregar.`;
        return;
      }
      const data = await r.json();
      $("#status").textContent = `${data.count} item(ns)`;
      render(data.items || []);
    }catch(e){
      $("#status").textContent = "Falha de rede ao carregar.";
    }
  }

  function render(items){
    const tb = $("#rows"); tb.innerHTML = "";
    for(const it of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.filename}${it.has_secret?'<span class="badge lock">Protegido</span>':''}</td>
        <td class="nowrap">${fmtSize(it.size)}</td>
        <td class="nowrap">${fmtDate(it.expires_at)}</td>
        <td class="nowrap">${it.owner_name || it.owner_id || "—"}</td>
        <td class="nowrap"></td>
      `;

      const actions = document.createElement("div");
      actions.className = "btn-row";

      // Baixar
      const btnDown = document.createElement("button");
      btnDown.className="btn";
      btnDown.type="button";
      btnDown.textContent="Baixar";
      btnDown.onclick = async ()=>{
        const fd = new FormData();
        if(it.has_secret && !isSuperuser){
          const s = prompt("Informe a chave secreta para baixar:");
          if(s===null) return;
          fd.set("secret", s);
        }
        const r = await fetch(`/api/automations/fileshare/items/${it.id}/download`, { method:"POST", body: fd, credentials:"include" });
        if(!r.ok){ alert("Não foi possível baixar (verifique a chave)"); return; }
        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob); a.download = it.filename; a.click();
        URL.revokeObjectURL(a.href);
      };
      actions.appendChild(btnDown);

      const isOwner = currentUserId && it.owner_id && String(currentUserId) === String(it.owner_id);
      const canOwnerActions = isOwner || isSuperuser;

      // Link (apenas dono ou superuser)
      if (canOwnerActions) {
        const btnShare = document.createElement("button");
        btnShare.className="btn secondary";
        btnShare.type="button";
        btnShare.textContent="Link";
        btnShare.onclick = async ()=>{
          const fd = new FormData();
          const expires = prompt("Validade do link: 1d, 7d ou 30d", "7d") || "7d";
          fd.set("expires", expires);
          if (it.has_secret && !isSuperuser) {
            const s = prompt("Informe a senha do arquivo para gerar o link:");
            if (s === null || s.trim() === "") { alert("Senha é obrigatória para gerar link deste arquivo."); return; }
            fd.set("secret", s.trim());
          }
          const r = await fetch(`/api/automations/fileshare/items/${it.id}/share`, { method:"POST", body: fd, credentials:"include" });
          if(!r.ok){
            const msg = await r.text().catch(()=> "");
            alert("Falha ao gerar link: " + (msg || r.status));
            return;
          }
          const data = await r.json();
          await navigator.clipboard.writeText(location.origin + data.download_url);
          alert("Link copiado para a área de transferência!");
        };
        actions.appendChild(btnShare);
      }

      // Excluir (apenas dono ou superuser)
      if (canOwnerActions) {
        const btnDel = document.createElement("button");
        btnDel.className="btn secondary";
        btnDel.type="button";
        btnDel.textContent="Excluir";
        btnDel.onclick = async ()=>{
          if(!confirm("Excluir este arquivo?")) return;
          const r = await fetch(`/api/automations/fileshare/items/${it.id}/delete`, { method:"POST", credentials:"include" });
          if(!r.ok){ alert("Falha ao excluir"); return; }
          load();
        };
        actions.appendChild(btnDel);
      }

      tr.querySelector("td:last-child").appendChild(actions);
      tb.appendChild(tr);
    }
  }

  // Eventos
  $("#frm").addEventListener("submit", upload);
  $("#btnRefresh").addEventListener("click", load);
  $("#btnApply").addEventListener("click", load);
  // Enter no campo de busca aciona filtro
  $("#q").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); load(); } });

  document.addEventListener("DOMContentLoaded", async ()=>{
    $("#owner").value = "all";
    await getMe();
    setupDropzone();
    await load();
  });
</script>
</body>
</html>
