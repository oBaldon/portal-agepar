<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fileshare — Uploader temporário</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#fff; --pri:#2563eb; }
  * { box-sizing:border-box }
  html,body { margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; }

  .wrap { max-width: 960px; margin: 20px auto; padding: 0 16px; }
  .wide { max-width: min(1280px, calc(100vw - 32px)); margin: 14px auto 20px; padding: 0 16px; }

  .card { background:var(--card); border:1px solid #e2e8f0; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  h1 { font-size:18px; margin:0 0 10px }
  label { display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
  input, select { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; font:inherit; background:#fff; }

  .row { display:flex; gap:12px; }
  .row > * { flex:1; }

  .btn { background:var(--pri); color:#fff; border:1px solid transparent; border-radius:10px; padding:10px 14px; cursor:pointer; flex:0 0 auto; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn[disabled] { opacity:.55; cursor:not-allowed; }

  .btn-row { display:flex; gap:8px; align-items:center; }
  .btn-row.right { justify-content:flex-end; }

  .toolbar { display:flex; align-items:center; gap:8px; margin-top:10px; }
  .toolbar .spacer { flex:1; }

  .dropzone {
    border:2px dashed #94a3b8;
    background:#f8fafc;
    border-radius:12px;
    padding:22px;
    text-align:center;
    color:#475569;
    cursor:pointer;
    transition:border-color .15s ease, background .15s ease;
  }
  .dropzone:hover { background:#f1f5f9; }
  .dropzone.dragover { border-color:#2563eb; background:#eff6ff; }
  .dropzone .title { font-weight:600; color:#0f172a; }
  .dropzone .hint { font-size:12px; color:#64748b; margin-top:6px; }
  .file-info { margin-top:8px; font-size:12px; color:#475569; }

  table { width:100%; border-collapse:collapse; margin-top:12px; background:#fff; }
  th, td { padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; }
  th { font-size:12px; color:#64748b; background:#f8fafc; }
  .nowrap { white-space:nowrap }
  .muted { color:#64748b; font-size:12px; }

  th:nth-child(5), td:nth-child(5) { text-align:center; width:280px; }

  .badge {
    display:inline-block; font-size:11px; line-height:1; padding:4px 6px;
    border-radius:999px; border:1px solid #cbd5e1; background:#f1f5f9; color:#334155; margin-left:6px;
    vertical-align:middle;
  }
  .badge.lock { border-color:#94a3b8; background:#e2e8f0; }

  .table-wrap { overflow-x:auto; }
  @media (max-width: 800px){ .row { flex-direction:column; } }
  @media (max-width: 600px){ th:nth-child(5), td:nth-child(5) { width:auto; } .btn-row.right { justify-content:flex-end; } .toolbar { gap:6px; } }

  dialog#shareDlg { border:none; padding:0; background:transparent; }
  dialog#shareDlg::backdrop { background: rgba(15, 23, 42, .35); }
</style>
</head>
<body>

<div class="wrap">
  <h1>Uploader temporário (Fileshare)</h1>

  <div class="card">
    <form id="frm" enctype="multipart/form-data" novalidate>
      <label for="fileInput">Arquivo</label>
      <input id="fileInput" type="file" name="file" required style="display:none" />
      <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Área para arrastar ou clicar para selecionar arquivo">
        <div class="title">Arraste e solte o arquivo aqui</div>
        <div class="hint">ou clique para selecionar no seu computador</div>
        <div id="fileInfo" class="file-info" style="display:none"></div>
      </div>

      <div class="row">
        <div>
          <label for="ttl">Tempo de vida</label>
          <select id="ttl" name="ttl">
            <option value="1d">1 dia</option>
            <option value="7d" selected>1 semana</option>
            <option value="30d">1 mês</option>
          </select>
        </div>
        <div>
          <label for="secret">Chave secreta (opcional)</label>
          <input id="secret" name="secret" placeholder="Senha para baixar" autocomplete="new-password"/>
        </div>
      </div>

      <div class="btn-row right" style="margin-top:10px">
        <button class="btn" id="btnSend" type="submit">Enviar</button>
      </div>
    </form>
  </div>
</div>

<div class="wide">
  <div class="card">
    <div class="row">
      <div>
        <label for="owner">Mostrar</label>
        <select id="owner">
          <option value="all" selected>Todos</option>
          <option value="me">Meus</option>
        </select>
      </div>
      <div>
        <label for="q">Busca</label>
        <input id="q" placeholder="nome do arquivo..." />
      </div>
</div>

    <div class="toolbar">
      <span class="muted" id="status" aria-live="polite"></span>
      <div class="spacer"></div>
      <button class="btn secondary" id="btnRefresh" type="button">Atualizar lista</button>
      <button class="btn" id="btnApply" type="button">Filtrar</button>
    </div>

    <div class="table-wrap">
      <table aria-describedby="status">
        <thead>
          <tr>
            <th>ARQUIVO</th>
            <th class="nowrap">TAMANHO</th>
            <th class="nowrap">EXPIRA</th>
            <th class="nowrap">DONO</th>
            <th class="nowrap">AÇÕES</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>


<!-- Modal: gerar link público -->
<dialog id="shareDlg" aria-label="Gerar link público">
  <div class="card" style="max-width:520px; margin:0; border-radius:14px;">
    <h2 style="font-size:16px; margin:0 0 8px;">Gerar link</h2>
    <div class="muted" id="shareFilename" style="margin-bottom:10px;"></div>

    <label for="shareExpiresDlg">Validade do link</label>
    <select id="shareExpiresDlg">
      <option value="1d">1 dia</option>
      <option value="7d" selected>1 semana</option>
      <option value="30d">1 mês</option>
    </select>

    <div id="shareSecretWrap" style="display:none; margin-top:10px;">
      <label for="shareSecretDlg">Senha do arquivo</label>
      <input id="shareSecretDlg" placeholder="Obrigatória para este arquivo" autocomplete="new-password"/>
      <div class="muted" style="margin-top:6px;">Para arquivos protegidos, a senha é exigida para gerar o link (exceto superusuário).</div>
    </div>

    <div class="btn-row right" style="margin-top:14px;">
      <button class="btn secondary" id="shareCancel" type="button">Cancelar</button>
      <button class="btn" id="shareOk" type="button">Gerar link</button>
    </div>
  </div>
</dialog>


<script>
  const $ = sel => document.querySelector(sel);
  const fmtSize = n => (!Number.isFinite(n) ? "—" : (n<1024? `${n} B` : n<1024**2? `${(n/1024).toFixed(1)} KB` : `${(n/1024**2).toFixed(1)} MB`));
  const fmtDate = s => { const d = new Date(s); return isNaN(d) ? "—" : d.toLocaleString(); };
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  let currentUser = { id: null, cpf: null, isSuperuser: false };

  // ---------- Share (modal) ----------
  let shareCtx = null;

  function _isValidTTL(v){ return v === "1d" || v === "7d" || v === "30d"; }

  function openShareModal(item){
    const dlg = $("#shareDlg");
    if(!dlg || typeof dlg.showModal !== "function") return false;

    shareCtx = item;

    const fn = $("#shareFilename");
    if(fn) fn.textContent = item?.filename ? `Arquivo: ${item.filename}` : "Arquivo";

    const sel = $("#shareExpiresDlg");
    if(sel) sel.value = "7d";

    const wrap = $("#shareSecretWrap");
    const input = $("#shareSecretDlg");
    const needSecret = !!item?.has_secret && !currentUser.isSuperuser;

    if(wrap) wrap.style.display = needSecret ? "block" : "none";
    if(input){
      input.value = "";
      input.required = needSecret;
    }

    dlg.showModal();
    if(needSecret && input) { try { input.focus(); } catch(_) {} }
    return true;
  }

  function closeShareModal(){
    const dlg = $("#shareDlg");
    if(dlg && dlg.open) dlg.close();
    shareCtx = null;

    const ok = $("#shareOk");
    if(ok){ ok.disabled = false; ok.textContent = "Gerar link"; }
  }

  async function confirmShare(){
    if(!shareCtx) return;

    const ok = $("#shareOk");
    if(ok){ ok.disabled = true; ok.textContent = "Gerando..."; }

    const sel = $("#shareExpiresDlg");
    const expires = (sel && sel.value) ? String(sel.value) : "7d";
    if(!_isValidTTL(expires)){
      alert("Validade inválida. Selecione uma das opções disponíveis.");
      if(ok){ ok.disabled = false; ok.textContent = "Gerar link"; }
      return;
    }

    const fd = new FormData();
    fd.set("expires", expires);

    const needSecret = !!shareCtx?.has_secret && !currentUser.isSuperuser;
    if(needSecret){
      const input = $("#shareSecretDlg");
      const s = (input?.value || "").trim();
      if(!s){
        alert("Senha é obrigatória para gerar link deste arquivo.");
        if(ok){ ok.disabled = false; ok.textContent = "Gerar link"; }
        return;
      }
      fd.set("secret", s);
    }

    try{
      const r = await fetch(`/api/automations/fileshare/items/${encodeURIComponent(shareCtx.id)}/share`, {
        method:"POST",
        body: fd,
        credentials:"include"
      });
      if(!r.ok){
        const msg = await r.text().catch(()=> "");
        alert("Falha ao gerar link: " + (msg || r.status));
        if(ok){ ok.disabled = false; ok.textContent = "Gerar link"; }
        return;
      }

      const data = await r.json();
      const full = (data.download_url?.startsWith("http") ? data.download_url : (location.origin + (data.download_url || "")));
      try {
        await navigator.clipboard.writeText(full);
        alert("Link copiado para a área de transferência!");
      } catch(_) {
        prompt("Copie o link manualmente:", full);
      }

      closeShareModal();
    }catch(_){
      alert("Falha de rede ao gerar link.");
      if(ok){ ok.disabled = false; ok.textContent = "Gerar link"; }
    }
  }



  async function getMe(){
    try{
      const r = await fetch("/api/me", { credentials:"include" });
      if(!r.ok) return;
      const me = await r.json();
      currentUser.id = me?.id || me?.user_id || null;
      currentUser.cpf = me?.cpf || null;
      currentUser.isSuperuser = !!me?.is_superuser;
    }catch(_){}
  }

  // ---------- Dropzone ----------
  function setupDropzone(){
    const dz = $("#dropzone");
    const fi = $("#fileInput");
    const info = $("#fileInfo");

    function showFileInfo(file){
      if(!file){ info.style.display="none"; info.textContent=""; return; }
      info.style.display="block";
      info.textContent = `Selecionado: ${file.name} (${fmtSize(file.size)})`;
    }

    dz.addEventListener("click", () => fi.click());
    dz.addEventListener("keydown", (ev) => {
      if(ev.key === "Enter" || ev.key === " "){ ev.preventDefault(); fi.click(); }
    });

    ["dragenter","dragover"].forEach(evt => {
      dz.addEventListener(evt, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); dz.classList.add("dragover"); });
    });
    ["dragleave","drop"].forEach(evt => {
      dz.addEventListener(evt, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); dz.classList.remove("dragover"); });
    });
    dz.addEventListener("drop", (ev)=>{
      const files = ev.dataTransfer?.files;
      if(!files || files.length===0) return;
      if(files.length>1){ alert("Selecione apenas um arquivo por envio."); return; }
      const dt = new DataTransfer();
      dt.items.add(files[0]);
      fi.files = dt.files;
      showFileInfo(files[0]);
    });

    fi.addEventListener("change", ()=> showFileInfo(fi.files?.[0]));
  }

  // ---------- Upload ----------
  async function upload(ev){
    ev.preventDefault();

    const form = ev.target;
    const fi = $("#fileInput");
    const btn = $("#btnSend");
    if(!fi.files || fi.files.length === 0){
      alert("Selecione um arquivo para enviar.");
      return;
    }

    const fd = new FormData(form);

    btn.disabled = true;
    const oldLabel = btn.textContent;
    btn.textContent = "Enviando...";

    try{
      const r = await fetch("/api/automations/fileshare/submit", {
        method:"POST",
        body: fd,
        credentials:"include"
      });
      if(!r.ok){
        let msg = ""; try { msg = await r.text(); } catch(_){}
        if(r.status === 413) alert("Arquivo excede o limite configurado no servidor.");
        else if(r.status === 415) alert("Tipo de arquivo não permitido pela política do servidor.");
        else if(r.status === 401) alert("Sessão expirada. Autentique-se novamente.");
        else alert(`Falha no upload (${r.status}). ${msg||""}`.trim());
        return;
      }
      await load();
      form.reset();
      const info = $("#fileInfo");
      if(info){ info.textContent=""; info.style.display="none"; }
    } catch(e){
      alert("Falha de rede ao enviar o arquivo.");
    } finally {
      btn.disabled = false;
      btn.textContent = oldLabel;
    }
  }

  // ---------- Listagem ----------
  async function load(){
    const owner = $("#owner").value;
    const q = $("#q").value.trim();
    const url = `/api/automations/fileshare/items?owner=${encodeURIComponent(owner)}&limit=100${q?`&q=${encodeURIComponent(q)}`:""}`;
    $("#status").textContent = "Carregando...";
    try{
      const r = await fetch(url, { credentials:"include" });
      if(!r.ok){
        $("#status").textContent = r.status === 401 ? "Não autenticado." : `Erro ${r.status} ao carregar.`;
        render([]); return;
      }
      const data = await r.json();
      $("#status").textContent = `${data.count ?? (data.items?.length||0)} item(ns)`;
      render(data.items || []);
    }catch(_){
      $("#status").textContent = "Falha de rede ao carregar.";
      render([]);
    }
  }

  function render(items){
    const tb = $("#rows");
    tb.innerHTML = "";
    for(const it of items){
      const tr = document.createElement("tr");

      // ARQUIVO (seguro contra XSS)
      const tdFile = document.createElement("td");
      const nameSpan = document.createElement("span");
      nameSpan.textContent = it.filename || "—";
      tdFile.appendChild(nameSpan);
      if (it.has_secret) {
        const b = document.createElement("span");
        b.className = "badge lock";
        b.textContent = "Protegido";
        tdFile.appendChild(b);
      }

      // TAMANHO
      const tdSize = document.createElement("td"); tdSize.className = "nowrap";
      tdSize.textContent = fmtSize(it.size);

      // EXPIRA
      const tdExp = document.createElement("td"); tdExp.className = "nowrap";
      tdExp.textContent = fmtDate(it.expires_at);

      // DONO
      const tdOwner = document.createElement("td"); tdOwner.className = "nowrap";
      tdOwner.textContent = it.owner_name || it.owner_id || "—";

      // AÇÕES
      const tdActions = document.createElement("td"); tdActions.className = "nowrap";
      const actions = document.createElement("div"); actions.className = "btn-row";

      // Baixar
      const btnDown = document.createElement("button");
      btnDown.className="btn";
      btnDown.type="button";
      btnDown.textContent="Baixar";
      btnDown.onclick = async ()=>{
        const fd = new FormData();
        if(it.has_secret && !currentUser.isSuperuser){
          const s = prompt("Informe a chave secreta para baixar:");
          if(s===null) return;
          fd.set("secret", s);
        }
        const r = await fetch(`/api/automations/fileshare/items/${encodeURIComponent(it.id)}/download`, { method:"POST", body: fd, credentials:"include" });
        if(!r.ok){ alert("Não foi possível baixar (verifique a chave)"); return; }
        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = it.filename || "arquivo";
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      };
      actions.appendChild(btnDown);

      const isOwner = (() => {
        const oid = it.owner_id != null ? String(it.owner_id) : "";
        return (currentUser.id && String(currentUser.id) === oid) || (currentUser.cpf && String(currentUser.cpf) === oid);
      })();
      const canOwnerActions = isOwner || currentUser.isSuperuser;

      // Link
      if (canOwnerActions) {
        const btnShare = document.createElement("button");
        btnShare.className="btn secondary";
        btnShare.type="button";
        btnShare.textContent="Link";
        btnShare.onclick = async ()=>{
          // Preferir modal com seleção fechada de prazos.
          if (openShareModal(it)) return;

          // Fallback (navegadores sem <dialog>): validação estrita, sem default silencioso.
          const raw = prompt("Validade do link (1d, 7d ou 30d):", "7d");
          if (raw === null) return;
          const expires = String(raw || "").trim();
          if(!_isValidTTL(expires)){
            alert("Validade inválida. Use 1d, 7d ou 30d.");
            return;
          }

          const fd = new FormData();
          fd.set("expires", expires);

          if (it.has_secret && !currentUser.isSuperuser) {
            const s = prompt("Informe a senha do arquivo para gerar o link:");
            if (s === null || s.trim() === "") { alert("Senha é obrigatória para gerar link deste arquivo."); return; }
            fd.set("secret", s.trim());
          }

          const r = await fetch(`/api/automations/fileshare/items/${encodeURIComponent(it.id)}/share`, { method:"POST", body: fd, credentials:"include" });
          if(!r.ok){
            const msg = await r.text().catch(()=> "");
            alert("Falha ao gerar link: " + (msg || r.status));
            return;
          }
          const data = await r.json();
          const full = (data.download_url?.startsWith("http") ? data.download_url : (location.origin + (data.download_url || "")));
          try {
            await navigator.clipboard.writeText(full);
            alert("Link copiado para a área de transferência!");
          } catch(_) {
            prompt("Copie o link manualmente:", full);
          }
        };
        actions.appendChild(btnShare);
      }

      // Excluir
      if (canOwnerActions) {
        const btnDel = document.createElement("button");
        btnDel.className="btn secondary";
        btnDel.type="button";
        btnDel.textContent="Excluir";
        btnDel.onclick = async ()=>{
          if(!confirm("Excluir este arquivo?")) return;
          const r = await fetch(`/api/automations/fileshare/items/${encodeURIComponent(it.id)}/delete`, { method:"POST", credentials:"include" });
          if(!r.ok){ alert("Falha ao excluir"); return; }
          load();
        };
        actions.appendChild(btnDel);
      }

      tdActions.appendChild(actions);

      tr.appendChild(tdFile);
      tr.appendChild(tdSize);
      tr.appendChild(tdExp);
      tr.appendChild(tdOwner);
      tr.appendChild(tdActions);

      tb.appendChild(tr);
    }
  }

  // Eventos
  $("#frm").addEventListener("submit", upload);
  $("#btnRefresh").addEventListener("click", load);
  $("#btnApply").addEventListener("click", load);
  $("#q").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); load(); } });

  document.addEventListener("DOMContentLoaded", async ()=>{
    $("#owner").value = "all";
    await getMe();
    setupDropzone();
    // Modal de geração de link (opcional; requer suporte a <dialog>)
    const dlg = $("#shareDlg");
    const btnCancel = $("#shareCancel");
    const btnOk = $("#shareOk");
    if(btnCancel) btnCancel.addEventListener("click", closeShareModal);
    if(btnOk) btnOk.addEventListener("click", confirmShare);
    if(dlg){
      // Impede fechamento que deixe o estado interno inconsistente
      dlg.addEventListener("cancel", (e)=>{ e.preventDefault(); closeShareModal(); });
    }

    await load();
  });
</script>
</body>
</html>