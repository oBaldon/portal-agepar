<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Detalhe do usuário · v0.1.0</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#fff; --pri:#2563eb; --bd:#e2e8f0; --ok:#059669; --warn:#b45309; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  h1 { font-size:20px; margin:0 0 8px; }
  .muted { color:var(--muted); }
  .btn { background:var(--pri); color:#fff; border:1px solid transparent; border-radius:10px; padding:10px 16px; text-decoration:none; display:inline-block; cursor:pointer; }
  .btn.secondary { background:#fff; color:#334155; border-color:#cbd5e1; }
  .btn.small { padding:8px 12px; font-size:12px; }
  .btn.ghost { background:transparent; color:var(--pri); border-color:transparent; }
  .card { background:var(--card); border:1px solid var(--bd); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:16px; }
  .stack { display: grid; gap:16px; }
  table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px; table-layout:fixed; }
  th,td { padding:10px 12px; border-bottom:1px solid var(--bd); vertical-align:top; text-align:left; }
  th { font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--muted); background:#f8fafc; position:sticky; top:0; z-index:1; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  .section { background:#f1f5f9; font-weight:600; }
  .kv th { width:240px; }
  .toolbar { display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
  .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; border:1px solid var(--bd); padding:4px 8px; border-radius:999px; }
  .empty { color:var(--muted); padding:8px 0; }
  .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
  @media (min-width: 780px){ .grid { grid-template-columns: 1fr 1fr; } }

  /* ===== Diff (grid) ===== */
  .diff { border:1px solid var(--bd); border-radius:12px; overflow:hidden; background:#fff; }
  .diff-group { border-top:1px solid var(--bd); }
  .diff-group:first-child { border-top:none; }
  .diff-group-header { background:#f8fafc; padding:8px 12px; display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:600; }
  .diff-grid { display:grid; grid-template-columns: 1.2fr 1fr 1fr; }
  .diff-cell { padding:8px 12px; border-top:1px solid var(--bd); white-space:pre-wrap; word-break:break-word; overflow:auto; max-height:180px; }
  .diff-head .diff-cell { font-weight:600; background:#fff; position:sticky; top:0; z-index:0; }
  .diff-after { background:#f0fdf4; }

  /* ===== Modal ===== */
  .hidden { display:none !important; }
  .modal-open { overflow:hidden; }
  .modal-overlay { position:fixed; inset:0; background:rgba(15,23,42,.5); display:flex; align-items:center; justify-content:center; padding:16px; z-index:9999; }
  .modal { background:var(--card); border:1px solid var(--bd); border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.2); max-width:980px; width:100%; max-height:85vh; display:flex; flex-direction:column; }
  .modal-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--bd); }
  .modal-title { font-size:16px; font-weight:600; }
  .modal-body { padding:12px 16px; overflow:auto; }
  .modal-actions { display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--bd); justify-content:flex-end; }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>Detalhe do usuário <span class="muted">· v0.1.0</span></h1>
    <div class="toolbar">
      <a class="btn secondary small" id="btn_voltar" href="/api/automations/usuarios/ui/search">Voltar</a>
      <a class="btn small" id="btn_editar" href="#">Editar</a>
      <button class="btn ghost small" id="btn_recarregar" type="button">Recarregar</button>
    </div>
  </div>

  <div class="stack">
    <!-- Bloco: dados completos -->
    <div class="card">
      <table class="kv">
        <thead>
          <tr><th>Campo</th><th>Valor</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="muted">Carregando…</td><td></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Bloco: histórico -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
        <h2 style="font-size:16px;margin:0">Histórico de alterações</h2>
        <span id="hist_meta" class="pill">0 evento(s)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:180px">Data/hora</th>
            <th style="width:120px">Ação</th>
            <th>Autor</th>
            <th style="width:160px">Alterações</th>
          </tr>
        </thead>
        <tbody id="hist_tbody">
          <tr><td class="empty" colspan="4">Carregando…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para diffs -->
<div id="diff_modal" class="modal-overlay hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="diff_modal_title">
    <div class="modal-header">
      <div id="diff_modal_title" class="modal-title">Alterações</div>
      <button id="diff_modal_close_x" class="btn secondary small" type="button">Fechar</button>
    </div>
    <div id="diff_modal_body" class="modal-body"></div>
    <div class="modal-actions">
      <button id="diff_modal_close" class="btn secondary small" type="button">Fechar</button>
    </div>
  </div>
</div>

<script>
  const TB = document.getElementById("tbody");
  const HB = document.getElementById("hist_tbody");
  const HM = document.getElementById("hist_meta");
  const btnEditar = document.getElementById("btn_editar");
  const btnRecarregar = document.getElementById("btn_recarregar");

  // Modal helpers
  const modal = document.getElementById("diff_modal");
  const modalBody = document.getElementById("diff_modal_body");
  const modalTitle = document.getElementById("diff_modal_title");
  const closeBtns = [document.getElementById("diff_modal_close"), document.getElementById("diff_modal_close_x")];

  function openModal(title, html){
    modalTitle.textContent = title || "Alterações";
    modalBody.innerHTML = html || "";
    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
    (closeBtns[0] || closeBtns[1]).focus();
  }
  function closeModal(){
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  }
  closeBtns.forEach(b => b.addEventListener("click", closeModal));
  modal.addEventListener("click", (ev) => {
    if (ev.target === modal) closeModal();
  });
  window.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape" && !modal.classList.contains("hidden")) closeModal();
  });

  // Render helpers
  function cell(v){
    if (v == null) return "-";
    if (Array.isArray(v)) return v.length ? `<ul>${v.map(x=>`<li>${cell(x)}</li>`).join("")}</ul>` : "-";
    if (typeof v === "object") {
      return `<pre class="mono" style="white-space:pre-wrap">${escapeHtml(JSON.stringify(v, null, 2))}</pre>`;
    }
    return String(v);
  }
  function row(k, v, mono=false){
    const cls = mono ? ' class="mono"' : '';
    return `<tr><th>${escapeHtml(k)}</th><td${cls}>${cell(v)}</td></tr>`;
  }
  function section(label){
    return `<tr class="section"><td colspan="2">${escapeHtml(label)}</td></tr>`;
  }
  function escapeHtml(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,'&quot;').replace(/'/g,"&#039;");
  }
  function getUserIdFromPath(){
    const parts = location.pathname.split("/");
    return parts[parts.length-1];
  }
  function fmtDateTime(s){
    if (!s) return "-";
    try {
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return String(s);
      return d.toLocaleString();
    } catch { return String(s); }
  }
  function prettyVal(v){
    if (v === null || v === undefined || v === "") return "<span class='muted'>∅</span>";
    if (typeof v === "object") return escapeHtml(JSON.stringify(v, null, 2));
    return escapeHtml(String(v));
  }

  function groupChanges(changes){
    const groups = { "Núcleo (user)": [], "Emprego": [], "Educação": [], "Outros": [] };
    for (const ch of (changes||[])){
      const p = String(ch.path || "");
      if (p.startsWith("user.")) groups["Núcleo (user)"].push(ch);
      else if (p.startsWith("employment.")) groups["Emprego"].push(ch);
      else if (p.startsWith("educacao.") || p.startsWith("educação.")) groups["Educação"].push(ch);
      else groups["Outros"].push(ch);
    }
    return Object.entries(groups).filter(([,arr]) => arr.length > 0);
  }

  function renderChanges(changes){
    const groups = groupChanges(changes);
    if (groups.length === 0) return "<div class='empty'>Sem alterações.</div>";
    const htmlGroups = groups.map(([title, arr]) => {
      const bodyRows = arr.map(ch => `
        <div class="diff-cell mono">${escapeHtml(ch.path||"-")}</div>
        <div class="diff-cell mono">${prettyVal(ch.before)}</div>
        <div class="diff-cell diff-after mono">${prettyVal(ch.after)}</div>
      `).join("");
      return `
        <div class="diff-group">
          <div class="diff-group-header">
            <div>${escapeHtml(title)}</div>
            <span class="pill">${arr.length}</span>
          </div>
          <div class="diff-grid diff-head">
            <div class="diff-cell">Campo</div>
            <div class="diff-cell">Antes</div>
            <div class="diff-cell">Depois</div>
          </div>
          <div class="diff-grid">${bodyRows}</div>
        </div>`;
    }).join("");
    return `<div class="diff">${htmlGroups}</div>`;
  }

  async function loadDetail(userId){
    const url = new URL(`/api/automations/usuarios/users/${encodeURIComponent(userId)}`, location.origin);
    const res = await fetch(url.toString(), { credentials:"include" });
    if (!res.ok){ TB.innerHTML = `<tr><td colspan="2">Erro HTTP ${res.status}</td></tr>`; return; }
    const data = await res.json();

    const u = data.user || {};
    const e = data.employment || {};
    const edu = data.educacao || {};

    const rows = [];
    rows.push(section("Núcleo (users)"));
    rows.push(row("ID", u.id, true));
    rows.push(row("Nome completo", u.nome_completo));
    rows.push(row("CPF", u.cpf, true));
    rows.push(row("RG", u.rg, true));
    rows.push(row("ID funcional", u.id_funcional, true));
    rows.push(row("Data de nascimento", u.data_nascimento));
    rows.push(row("E-mail principal", u.email_principal));
    rows.push(row("E-mail institucional", u.email_institucional));
    rows.push(row("Telefone principal", u.telefone_principal));
    rows.push(row("Ramal", u.ramal));
    rows.push(row("Endereço", u.endereco));
    rows.push(row("Dependentes (qtde)", u.dependentes_qtde));
    rows.push(row("Formação: nível médio", u.formacao_nivel_medio ? "Sim" : "Não"));
    rows.push(row("Status (users.status)", u.status_usuario));

    rows.push(section("Emprego atual (employment)"));
    if (!e || Object.keys(e).length === 0){
      rows.push(row("Emprego", "Sem vínculo atual"));
    } else {
      rows.push(row("Employment ID", e.employment_id, true));
      rows.push(row("Tipo de vínculo", e.tipo_vinculo));
      rows.push(row("Status do vínculo", e.status_vinculo));
      rows.push(row("Motivo da inatividade", e.motivo_inatividade || "-"));
      rows.push(row("Início", e.start_date || "-"));
      rows.push(row("Fim", e.end_date || "-"));
      const org = e.org_unit ? `${e.org_unit.code || "-"} — ${e.org_unit.name || "-"}` : "-";
      rows.push(row("Unidade organizacional", org));

      if (e.tipo_vinculo === "efetivo" && e.efetivo){
        const ef = e.efetivo || {};
        rows.push(section("Especialização: EFETIVO"));
        rows.push(row("Decreto nomeação (nº)", ef.decreto_nomeacao_numero));
        rows.push(row("Decreto nomeação (data)", ef.decreto_nomeacao_data));
        rows.push(row("Posse (data)", ef.posse_data));
        rows.push(row("Exercício (data)", ef.exercicio_data));
        rows.push(row("Lotação (portaria)", ef.lotacao_portaria));
        rows.push(row("Cedido de", ef.cedido_de));
        rows.push(row("Cedido para", ef.cedido_para));
        rows.push(row("Classe", ef.classe));
        rows.push(row("Estabilidade (data)", ef.estabilidade_data));
        rows.push(row("Estabilidade (protocolo)", ef.estabilidade_protocolo));
        rows.push(row("Estabilidade (resolução conjunta)", ef.estabilidade_resolucao_conjunta));
        rows.push(row("Estabilidade (publicação data)", ef.estabilidade_publicacao_data));

        rows.push(row("Capacitações", (ef.capacitacoes||[]).map(c => {
          return `Curso: ${escapeHtml(c.curso||"-")} | Conclusão: ${escapeHtml(c.conclusao_data||"-")} | Protocolo: ${escapeHtml(c.protocolo||"-")} | Decreto: ${escapeHtml(c.decreto_numero||"-")} | Resolução: ${escapeHtml(c.resolucao_conjunta||"-")} | Classe: ${escapeHtml(c.classe||"-")}`;
        }).join("\n")));
        rows.push(row("GITI", (ef.giti||[]).map(g => {
          return `Curso: ${escapeHtml(g.curso||"-")} | Conclusão: ${escapeHtml(g.conclusao_data||"-")} | Tipo: ${escapeHtml(g.tipo||"-")} | Percentual: ${escapeHtml(g.percentual??"-")}`;
        }).join("\n")));

        const oc = ef.outro_cargo;
        if (oc){
          rows.push(section("Efetivo — Outro cargo"));
          rows.push(row("Função/CC", oc.funcao_ou_cc));
          rows.push(row("Decreto nomeação (nº)", oc.decreto_nomeacao_numero));
          rows.push(row("Decreto nomeação (data)", oc.decreto_nomeacao_data));
          rows.push(row("Posse (data)", oc.posse_data));
          rows.push(row("Exercício (data)", oc.exercicio_data));
          rows.push(row("Símbolo", oc.simbolo));
          rows.push(row("Decreto exoneração (nº)", oc.decreto_exoneracao_numero));
          rows.push(row("Decreto exoneração (data)", oc.decreto_exoneracao_data));
        }
      }
      if (e.tipo_vinculo === "comissionado" && e.comissionado){
        const c = e.comissionado || {};
        rows.push(section("Especialização: COMISSIONADO"));
        rows.push(row("Decreto nomeação (nº)", c.decreto_nomeacao_numero));
        rows.push(row("Decreto nomeação (data)", c.decreto_nomeacao_data));
        rows.push(row("Posse (data)", c.posse_data));
        rows.push(row("Exercício (data)", c.exercicio_data));
        rows.push(row("Símbolo", c.simbolo));
        rows.push(row("Decreto exoneração (nº)", c.decreto_exoneracao_numero));
        rows.push(row("Decreto exoneração (data)", c.decreto_exoneracao_data));
        rows.push(row("Com vínculo?", c.com_vinculo===true ? "Sim" : (c.com_vinculo===false ? "Não" : "-")));
        rows.push(row("Função exercida", c.funcao_exercida));
      }
      if (e.tipo_vinculo === "estagiario" && e.estagiario){
        const s = e.estagiario || {};
        rows.push(section("Especialização: ESTAGIÁRIO"));
        rows.push(row("TCE (nº)", s.tce_numero));
        rows.push(row("TCE (ano)", s.tce_ano));
        rows.push(row("Início", s.inicio_data));
        rows.push(row("Fim", s.fim_data));
        rows.push(row("Aditivo (novo fim)", s.aditivo_novo_fim_data));
        rows.push(row("Rescisão (data)", s.rescisao_data));
        rows.push(row("Fluxogramas", s.fluxogramas));
        rows.push(row("Frequência", s.frequencia));
        rows.push(row("Pagamento", s.pagamento));
        rows.push(row("Vale-transporte", s.vale_transporte===true ? "Sim" : (s.vale_transporte===false ? "Não" : "-")));
      }
    }

    rows.push(section("Formação — Graduações"));
    (edu.graduacoes||[]).forEach((g, i) => {
      rows.push(row(`#${i+1}`, `Curso: ${escapeHtml(g.curso||"-")} | Instituição: ${escapeHtml(g.instituicao||"-")} | Conclusão: ${escapeHtml(g.conclusao_data||"-")}`));
    });
    if (!(edu.graduacoes||[]).length) rows.push(row("(nenhuma)", "-"));

    rows.push(section("Formação — Pós-graduações"));
    (edu.pos_graduacoes||[]).forEach((p, i) => {
      rows.push(row(`#${i+1}`, `Curso: ${escapeHtml(p.curso||"-")} | Tipo: ${escapeHtml(p.tipo||"-")} | Instituição: ${escapeHtml(p.instituicao||"-")} | Conclusão: ${escapeHtml(p.conclusao_data||"-")}`));
    });
    if (!(edu.pos_graduacoes||[]).length) rows.push(row("(nenhuma)", "-"));

    TB.innerHTML = rows.join("");
  }

  function renderHistory(items){
    if (!Array.isArray(items) || items.length === 0){
      HB.innerHTML = '<tr><td class="empty" colspan="4">Sem eventos.</td></tr>';
      HM.textContent = "0 evento(s)";
      return;
    }
    items = items.slice().sort((a,b) => String(b.at||"").localeCompare(String(a.at||"")));
    HM.textContent = `${items.length} evento(s)`;
    HB.innerHTML = "";
    for (const it of items){
      const changes = Array.isArray(it.changes) ? it.changes : [];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(fmtDateTime(it.at))}</td>
        <td>${escapeHtml(it.action === "create_user" ? "criação" : it.action)}</td>
        <td>
          <div>${escapeHtml(it.actor?.nome || "-")}</div>
          <div class="mono muted">${escapeHtml(it.actor?.email || "-")}</div>
          <div class="mono muted">${escapeHtml(it.actor?.cpf || "-")}</div>
        </td>
        <td class="changes-cell"></td>
      `;
      const cell = tr.querySelector(".changes-cell");
      if (changes.length === 0){
        cell.textContent = "-";
      } else {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn secondary small";
        btn.textContent = `${changes.length} alteração(ões)`;
        btn.addEventListener("click", () => {
          const title = `Alterações — ${fmtDateTime(it.at)} · ${it.action}`;
          openModal(title, renderChanges(changes));
        });
        cell.appendChild(btn);
      }
      HB.appendChild(tr);
    }
  }

  async function loadHistory(userId){
    const url = new URL(`/api/automations/usuarios/users/${encodeURIComponent(userId)}/history`, location.origin);
    const res = await fetch(url.toString(), { credentials: "include" });
    if (!res.ok){ HB.innerHTML = `<tr><td colspan="4">Erro HTTP ${res.status}</td></tr>`; HM.textContent = ""; return; }
    const data = await res.json();
    renderHistory(data.items || []);
  }

  async function boot(){
    const userId = getUserIdFromPath();
    btnEditar.href = `/api/automations/usuarios/ui/user/${encodeURIComponent(userId)}/edit`;
    document.getElementById("btn_voltar").href = "/api/automations/usuarios/ui/search";
    await Promise.all([loadDetail(userId), loadHistory(userId)]);
  }

  document.addEventListener("DOMContentLoaded", boot);
  btnRecarregar.addEventListener("click", () => boot());
</script>
</body>
</html>
